# Bug Fixes - November 10, 2025

## Fixes Applied

### Fix #1: Layer History Display - Timestamp Parsing

**File:** `resources/ext.layers.editor/LayersEditor.js`

**Problem:**
- MediaWiki timestamps are stored as `binary(14)` format: `YYYYMMDDHHmmss`
- Code was treating them as Unix timestamps (seconds since epoch)
- This caused `Invalid Date` to display
- Message `layers-revision-by` expects parameter replacement but wasn't being used correctly

**Changes:**
1. Added `parseMWTimestamp()` helper function to correctly parse MediaWiki timestamps
2. Fixed message parameter replacement to use MediaWiki's `.params()` method
3. Added fallback handling for invalid timestamps

**Testing:**
- Create multiple revisions with different timestamps
- Verify each shows unique, valid date/time
- Verify user names appear correctly  
- Verify revision names appear in parentheses

---

### Fix #2: Layer Drag and Drop (Analysis Only - No Code Changes Needed)

**File:** `resources/ext.layers.editor/LayerPanel.js`

**Analysis Result:**
After careful examination, the drag and drop code appears to be correctly implemented:
- `setupDragAndDrop()` uses event delegation on `this.layerList`
- Each layer item has `draggable=true` set in `createLayerItem()`
- Event listeners use `e.target.closest('.layer-item')` for proper delegation
- The `reorderLayers()` function correctly updates state and canvas

**Potential Issues:**
1. **CSS Issue:** The drag may be blocked by CSS `pointer-events` or `user-select`
2. **Browser Compatibility:** Some browsers require `-webkit-user-drag: element`
3. **Touch Devices:** Drag and drop may not work on touch devices without polyfill

**Recommended Testing:**
1. Test in Chrome/Firefox/Edge
2. Check browser console for errors during drag
3. Verify the grab icon is not blocking the drag start
4. Test with and without the grab icon

**If Still Not Working:**
- Check CSS for `pointer-events: none` on layer items or children
- Add explicit `-webkit-user-drag: element` to draggable items
- Verify no other JavaScript is preventing default drag behavior
- Check if there are conflicting event handlers

---

## Files Modified

1. `resources/ext.layers.editor/LayersEditor.js`
   - Added `parseMWTimestamp()` helper function (lines 520-537)
   - Modified `buildRevisionSelector()` to use correct timestamp parsing (lines 555-570)
   - Fixed message parameter replacement using `mw.message().text()` syntax

**Implementation Status:** âœ… **COMPLETE**

---

## Testing Checklist

### Fix #1 (Timestamp):
- [ ] Create multiple layer revisions at different times
- [ ] Check revision selector shows correct dates
- [ ] Verify "by Username" displays correctly
- [ ] Verify revision names show in parentheses
- [ ] Test with different timezone settings
- [ ] Verify "Latest (current)" appears correctly

### Fix #2 (Drag and Drop):
- [ ] Create 3-5 layers
- [ ] Try dragging each layer to different positions
- [ ] Verify visual feedback during drag
- [ ] Verify drop zones are indicated
- [ ] Verify order changes after drop
- [ ] Verify canvas updates with new order
- [ ] Test in Chrome, Firefox, Edge
- [ ] Check browser console for errors

---

**Fixes Applied:** November 10, 2025  
**Tested:** Pending user verification  
**Rollback:** Available via git if issues occur
