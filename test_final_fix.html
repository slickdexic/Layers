<!DOCTYPE html>
<html>
<head>
    <title>üéØ FINAL IMAGE TEST</title>
    <style>
        body { margin: 20px; font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .test-img { max-width: 200px; border: 2px solid #007cba; border-radius: 4px; display: block; margin: 10px auto; }
        .big-button { background: #28a745; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; display: block; margin: 20px auto; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .big-button:hover { background: #218838; transform: translateY(-1px); }
        .result { background: #f8f9fa; border-left: 4px solid #007cba; padding: 15px; margin: 20px 0; border-radius: 4px; }
        .success { border-left-color: #28a745; background: #d4edda; color: #155724; }
        .error { border-left-color: #dc3545; background: #f8d7da; color: #721c24; }
        .console { background: #000; color: #0f0; font-family: 'Courier New', monospace; padding: 10px; border-radius: 4px; font-size: 12px; white-space: pre-line; max-height: 300px; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ FINAL IMAGE LOADING TEST</h1>
        <p style="text-align: center;">This test verifies that the background image appears in the layers editor.</p>
        
        <img src="https://picsum.photos/500/300?random=999" alt="Test Image" class="test-img" id="testImg">
        <p style="text-align: center; font-size: 14px; color: #666;">‚Üë This image should appear as the background in the editor</p>
        
        <button class="big-button" onclick="runFinalTest()">üöÄ START LAYERS EDITOR</button>
        
        <div id="result" class="result" style="display: none;">
            <strong>Result:</strong> <span id="resultText">Testing...</span>
            <div id="console" class="console" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Minimal MediaWiki and jQuery mocks
        window.mw = {
            config: { get: k => ({ wgServer: location.protocol + '//' + location.host, wgScriptPath: '' }[k]) },
            hook: n => ({ add: cb => cb, fire: d => {} }),
            Api: () => ({ get: () => ({ done: cb => setTimeout(() => cb({layersinfo: {layerset: {data: {layers: []}}}}), 10), fail: () => ({}) }), post: () => ({ done: cb => setTimeout(() => cb({success: true}), 10), fail: () => ({}) }) }),
            notify: () => {}, msg: k => k
        };

        window.$ = function(s) {
            if (typeof s === 'function') return document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', s) : s();
            var els = typeof s === 'string' ? (s.startsWith('<') ? [document.createElement(s.match(/<(\w+)/)[1])] : Array.from(document.querySelectorAll(s))) : [s];
            return Object.assign(els, {
                addClass: function(c) { this.forEach(el => el.classList.add(c)); return this; },
                css: function(st) { this.forEach(el => Object.assign(el.style, st)); return this; },
                attr: function(n, v) { if (v !== undefined) { this.forEach(el => el.setAttribute(n, v)); return this; } return this[0]?.getAttribute(n); },
                appendTo: function(p) { var parent = typeof p === 'string' ? document.querySelector(p) : p; this.forEach(el => parent.appendChild(el)); return this; },
                get: function(i) { return this[i]; }, remove: function() { this.forEach(el => el.remove()); return this; },
                text: function(t) { if (t !== undefined) { this.forEach(el => el.textContent = t); return this; } return this[0]?.textContent; },
                fadeOut: function() { this.forEach(el => { el.style.opacity = '0'; setTimeout(() => el.style.display = 'none', 300); }); return this; },
                on: function(e, h) { this.forEach(el => el.addEventListener(e.split('.')[0], h)); return this; },
                off: function() { return this; }
            });
        };

        function showResult(text, isSuccess, showConsole = false) {
            var result = document.getElementById('result');
            var resultText = document.getElementById('resultText');
            var console = document.getElementById('console');
            
            result.style.display = 'block';
            result.className = 'result ' + (isSuccess ? 'success' : 'error');
            resultText.textContent = text;
            console.style.display = showConsole ? 'block' : 'none';
        }

        function logToConsole(msg) {
            var console = document.getElementById('console');
            var time = new Date().toLocaleTimeString();
            console.textContent += time + ': ' + msg + '\n';
            console.scrollTop = console.scrollHeight;
        }

        // Override console for capture
        var originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            logToConsole('LOG: ' + args.join(' '));
        };
        
        var originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            logToConsole('ERROR: ' + args.join(' '));
        };

        function loadScriptsAndTest() {
            var scripts = [
                'resources/ext.layers.editor/CanvasManager.js',
                'resources/ext.layers.editor/LayerPanel.js', 
                'resources/ext.layers.editor/Toolbar.js',
                'resources/ext.layers.editor/LayersEditor.js'
            ];
            
            var loadNext = function(index) {
                if (index >= scripts.length) {
                    setTimeout(createEditor, 100);
                    return;
                }
                
                var script = document.createElement('script');
                script.src = scripts[index];
                script.onload = () => loadNext(index + 1);
                script.onerror = () => {
                    showResult('Failed to load script: ' + scripts[index], false, true);
                };
                document.head.appendChild(script);
            };
            
            loadNext(0);
        }

        function createEditor() {
            try {
                logToConsole('Creating LayersEditor with imageUrl...');
                
                var config = {
                    filename: 'test-final.jpg',
                    imageUrl: document.getElementById('testImg').src  // THE KEY FIX!
                };
                
                logToConsole('Config: ' + JSON.stringify(config));
                
                var editor = new window.LayersEditor(config);
                
                // Wait for background image to load
                setTimeout(() => {
                    if (editor.canvasManager && editor.canvasManager.backgroundImage) {
                        var bgImg = editor.canvasManager.backgroundImage;
                        if (bgImg.complete && bgImg.width > 0) {
                            logToConsole('‚úÖ SUCCESS: Image loaded ' + bgImg.width + 'x' + bgImg.height);
                            showResult('‚úÖ SUCCESS! The background image is now visible in the editor!', true, true);
                        } else {
                            logToConsole('‚ùå Image object exists but not properly loaded');
                            showResult('‚ùå Image object created but not loaded properly', false, true);
                        }
                    } else {
                        logToConsole('‚ùå No background image found in CanvasManager');
                        showResult('‚ùå No background image object found', false, true);
                    }
                }, 3000);
                
            } catch (error) {
                logToConsole('‚ùå Error creating editor: ' + error.message);
                showResult('‚ùå Error: ' + error.message, false, true);
            }
        }

        function runFinalTest() {
            showResult('Loading editor components...', false, true);
            logToConsole('=== FINAL IMAGE LOADING TEST ===');
            logToConsole('Test image URL: ' + document.getElementById('testImg').src);
            
            if (typeof window.LayersEditor === 'undefined') {
                loadScriptsAndTest();
            } else {
                createEditor();
            }
        }
    </script>
</body>
</html>
