<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layers Extension - Step-by-Step Troubleshooting</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .step {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .step h2 {
            margin-top: 0;
            color: #333;
        }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .important {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
        }
        ul li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <h1>Layers Extension Troubleshooting Guide</h1>
    <p><strong>Date:</strong> August 8, 2025</p>
    <p>Follow these steps in order to identify exactly what's preventing the Layers extension from working.</p>

    <div class="step">
        <h2>Step 1: Verify Extension Loading</h2>
        <p>First, check if MediaWiki recognizes the Layers extension:</p>
        <ol>
            <li>Go to your MediaWiki site</li>
            <li>Navigate to <strong>Special:Version</strong></li>
            <li>Look for "Layers" in the extensions list</li>
        </ol>
        
        <div class="important">
            <strong>If Layers is NOT listed:</strong>
            <ul>
                <li>Check that <code>wfLoadExtension('Layers');</code> is in your LocalSettings.php</li>
                <li>Ensure the extension files are in <code>extensions/Layers/</code></li>
                <li>Check MediaWiki error logs for loading errors</li>
            </ul>
        </div>
        
        <div class="success">
            <strong>If Layers IS listed:</strong> ‚úÖ Extension is loaded, proceed to Step 2
        </div>
    </div>

    <div class="step">
        <h2>Step 2: Check Database Setup</h2>
        <p>The extension requires database tables to store layer data:</p>
        
        <div class="code">Run from your MediaWiki root directory:
php maintenance/update.php</div>
        
        <p>Look for messages about creating these tables:</p>
        <ul>
            <li>layer_sets</li>
            <li>layer_assets</li>
            <li>layer_set_usage</li>
        </ul>
        
        <div class="important">
            <strong>If you see errors:</strong> The database user may not have CREATE TABLE permissions
        </div>
    </div>

    <div class="step">
        <h2>Step 3: Test on a File Page</h2>
        <p>The "Edit Layers" tab only appears on file pages:</p>
        <ol>
            <li>Upload a test image if you don't have one (any JPG/PNG will work)</li>
            <li>Navigate to the file page (e.g., File:Test.jpg)</li>
            <li>Ensure you're logged in (anonymous users can't edit layers)</li>
            <li>Look for an "Edit Layers" tab next to the "Edit" tab</li>
        </ol>
        
        <div class="important">
            <strong>If no tab appears:</strong>
            <ul>
                <li>Check browser console for JavaScript errors</li>
                <li>Verify you're logged in</li>
                <li>Try adding <code>?layersdebug=1</code> to the URL to enable debug mode</li>
                <li>Check MediaWiki debug logs for hook errors</li>
            </ul>
        </div>
    </div>

    <div class="step">
        <h2>Step 4: Check Permissions</h2>
        <p>Users need the 'editlayers' permission:</p>
        <ol>
            <li>Go to <strong>Special:ListGroupRights</strong></li>
            <li>Check that the 'user' group has 'editlayers' permission</li>
            <li>Verify your account is in the 'user' group (or another group with the permission)</li>
        </ol>
        
        <div class="code">To manually grant permission, add to LocalSettings.php:
$wgGroupPermissions['user']['editlayers'] = true;</div>
    </div>

    <div class="step">
        <h2>Step 5: Test Layer Rendering</h2>
        <p>To test if layers can render on images:</p>
        <ol>
            <li>First, you need to create some layer data using the editor</li>
            <li>If the "Edit Layers" tab works, create a simple rectangle or text</li>
            <li>Save the layers</li>
            <li>Test rendering with: <code>[[File:YourImage.jpg|layers=all]]</code></li>
        </ol>
        
        <div class="important">
            <strong>Note:</strong> Layers won't render if no layer data exists. You must create layers first!
        </div>
    </div>

    <div class="step">
        <h2>Step 6: Check JavaScript Loading</h2>
        <p>Open browser developer tools (F12) and check:</p>
        <ol>
            <li>Go to the Console tab</li>
            <li>Look for any red errors mentioning 'layers' or 'mw.layers'</li>
            <li>Try typing: <code>typeof mw.layers</code> (should return 'object')</li>
            <li>Try typing: <code>typeof LayersViewer</code> (should return 'function')</li>
        </ol>
    </div>

    <div class="step">
        <h2>Step 7: Enable Debug Mode</h2>
        <p>For detailed debugging, add to LocalSettings.php:</p>
        
        <div class="code">$wgLayersDebug = true;
$wgDebugLogFile = "/path/to/debug.log";
$wgDebugLogGroups['Layers'] = true;</div>
        
        <p>Then check the debug log for detailed information about what's happening.</p>
    </div>

    <div class="step">
        <h2>Common Issues and Solutions</h2>
        
        <h3>‚ùå "Edit Layers" tab missing</h3>
        <ul>
            <li>Not logged in ‚Üí Log in with any user account</li>
            <li>Not on file page ‚Üí Navigate to File:SomeImage.jpg</li>
            <li>No permission ‚Üí Check Special:ListGroupRights</li>
            <li>Extension not loaded ‚Üí Check Special:Version</li>
        </ul>
        
        <h3>‚ùå Tab present but editor doesn't load</h3>
        <ul>
            <li>JavaScript errors ‚Üí Check browser console</li>
            <li>Module not loaded ‚Üí Check ResourceLoader in browser tools</li>
            <li>File not found ‚Üí Ensure the image actually exists</li>
        </ul>
        
        <h3>‚ùå Layers don't render with layers=all</h3>
        <ul>
            <li>No layer data ‚Üí Create layers first using the editor</li>
            <li>JavaScript not loaded ‚Üí Check console for errors</li>
            <li>Wrong syntax ‚Üí Use [[File:Image.jpg|layers=all]] exactly</li>
        </ul>
    </div>

    <div class="step">
        <h2>Quick Test Commands</h2>
        <p>Run these from your MediaWiki root to verify setup:</p>
        
        <div class="code"># Check if extension loads without errors
php maintenance/version.php | grep -i layers

# Verify database tables exist
php maintenance/sql.php --query "SHOW TABLES LIKE 'layer_%'"

# Test basic functionality
php extensions/Layers/verify-layers-installation.php</div>
    </div>

    <div class="success">
        <h2>‚úÖ Success Criteria</h2>
        <p>You'll know the extension is working when:</p>
        <ul>
            <li>Layers appears in Special:Version</li>
            <li>"Edit Layers" tab appears on file pages for logged-in users</li>
            <li>Clicking the tab opens the layer editor</li>
            <li>Created layers appear when using layers=all parameter</li>
            <li>No JavaScript errors in browser console</li>
        </ul>
    </div>

    <div class="error">
        <h2>üö® If Nothing Works</h2>
        <p>If you've tried all steps and still have issues:</p>
        <ol>
            <li>Check MediaWiki version compatibility (requires 1.44+)</li>
            <li>Try with a fresh MediaWiki installation</li>
            <li>Check server PHP error logs</li>
            <li>Disable other extensions temporarily to check for conflicts</li>
            <li>Verify file permissions on the extensions directory</li>
        </ol>
    </div>
</body>
</html>
