<!DOCTYPE html>
<html>
<head>
    <title>Image URL Test - Final Fix</title>
    <link rel="stylesheet" href="resources/ext.layers.editor/editor.css">
    <style>
        body { margin: 20px; font-family: Arial, sans-serif; }
        .test-container { max-width: 600px; margin: 0 auto; }
        .test-image { max-width: 200px; border: 1px solid #ddd; margin: 10px 0; }
        button { background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .debug { font-family: monospace; font-size: 12px; background: #000; color: #0f0; padding: 10px; border-radius: 4px; white-space: pre-line; max-height: 400px; overflow-y: auto; }
        .status { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üéØ Image URL Test - Final Fix</h1>
        
        <div class="status" id="status">Ready to test...</div>
        
        <h3>Test Image:</h3>
        <img src="https://picsum.photos/400/300?random=200" alt="Test Image" class="test-image" id="testImage">
        
        <div>
            <button onclick="testWithImageUrl()">‚úÖ Test with imageUrl (SHOULD WORK)</button>
            <button onclick="clearOutput()">Clear Output</button>
        </div>
        
        <div class="debug" id="debugOutput">Debug output will appear here...</div>
    </div>

    <script>
        // MediaWiki and jQuery mocks
        window.mw = {
            config: { get: (key) => ({ 'wgServer': location.protocol + '//' + location.host, 'wgScriptPath': '' }[key]) },
            hook: (name) => ({ add: (cb) => cb, fire: (data) => {} }),
            Api: () => ({ get: () => ({ done: (cb) => setTimeout(() => cb({layersinfo: {layerset: {data: {layers: []}}}}), 10), fail: () => ({}) }), post: () => ({ done: (cb) => setTimeout(() => cb({success: true}), 10), fail: () => ({}) }) }),
            notify: () => {}, msg: (key) => key
        };

        window.$ = function(sel) {
            if (typeof sel === 'function') return document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', sel) : sel();
            var els = typeof sel === 'string' ? (sel.startsWith('<') ? [document.createElement(sel.match(/<(\w+)/)[1])] : Array.from(document.querySelectorAll(sel))) : [sel];
            var jq = Object.assign(els, {
                addClass: function(c) { this.forEach(el => el.classList.add(c)); return this; },
                css: function(s) { this.forEach(el => Object.assign(el.style, s)); return this; },
                attr: function(n, v) { if (v !== undefined) { this.forEach(el => el.setAttribute(n, v)); return this; } return this[0]?.getAttribute(n); },
                appendTo: function(p) { var parent = typeof p === 'string' ? document.querySelector(p) : p; this.forEach(el => parent.appendChild(el)); return this; },
                get: function(i) { return this[i]; }, remove: function() { this.forEach(el => el.remove()); return this; },
                text: function(t) { if (t !== undefined) { this.forEach(el => el.textContent = t); return this; } return this[0]?.textContent; },
                fadeOut: function() { this.forEach(el => { el.style.opacity = '0'; setTimeout(() => el.style.display = 'none', 300); }); return this; },
                on: function(e, h) { this.forEach(el => el.addEventListener(e.split('.')[0], h)); return this; },
                off: function() { return this; }
            });
            return jq;
        };

        function log(msg) {
            var debug = document.getElementById('debugOutput');
            var time = new Date().toLocaleTimeString();
            debug.textContent += time + ': ' + msg + '\n';
            debug.scrollTop = debug.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('debugOutput').textContent = 'Debug cleared...\n';
            document.getElementById('status').textContent = 'Ready to test...';
        }

        function updateStatus(msg, isSuccess = false) {
            var status = document.getElementById('status');
            status.textContent = msg;
            status.style.background = isSuccess ? '#d4edda' : '#f8f9fa';
            status.style.borderColor = isSuccess ? '#c3e6cb' : '#e9ecef';
            status.style.color = isSuccess ? '#155724' : '#333';
        }

        // Override console methods
        var originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            log('LOG: ' + args.join(' '));
        };

        var originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            log('ERROR: ' + args.join(' '));
        };
    </script>

    <script src="resources/ext.layers.editor/CanvasManager.js"></script>
    <script src="resources/ext.layers.editor/LayerPanel.js"></script>
    <script src="resources/ext.layers.editor/Toolbar.js"></script>
    <script src="resources/ext.layers.editor/LayersEditor.js"></script>

    <script>
        function testWithImageUrl() {
            log('=== Testing with imageUrl in config (MediaWiki style) ===');
            updateStatus('Creating editor with imageUrl...');
            
            try {
                var testImg = document.getElementById('testImage');
                var imageUrl = testImg.src;
                
                // This is how MediaWiki will now call the editor (with imageUrl!)
                var config = {
                    filename: 'test-image.jpg',
                    imageUrl: imageUrl  // This is the KEY FIX!
                };
                
                log('Config with imageUrl: ' + JSON.stringify(config));
                
                var editor = new window.LayersEditor(config);
                
                // Check the result after a short delay
                setTimeout(function() {
                    if (editor.canvasManager && editor.canvasManager.backgroundImage) {
                        var bgImg = editor.canvasManager.backgroundImage;
                        if (bgImg.complete && bgImg.width > 0) {
                            log('üéâ SUCCESS! Background image loaded: ' + bgImg.width + 'x' + bgImg.height);
                            updateStatus('‚úÖ SUCCESS: Image loaded and visible in editor!', true);
                            
                            // Check if we can see it in the canvas
                            var canvas = document.querySelector('.layers-canvas');
                            if (canvas) {
                                log('Canvas found: ' + canvas.width + 'x' + canvas.height + ' (display: ' + canvas.style.width + ' x ' + canvas.style.height + ')');
                                updateStatus('‚úÖ SUCCESS: Image loaded, canvas ready for editing!', true);
                            }
                        } else {
                            log('‚ùå Image object exists but not loaded properly');
                            updateStatus('‚ùå Image object created but not loaded');
                        }
                    } else {
                        log('‚ùå No background image object found');
                        updateStatus('‚ùå No background image found in editor');
                    }
                }, 2000);
                
            } catch (error) {
                log('‚ùå ERROR: ' + error.message);
                updateStatus('‚ùå ERROR: ' + error.message);
            }
        }

        log('Page ready. Click "Test with imageUrl" to verify the fix.');
    </script>
</body>
</html>
