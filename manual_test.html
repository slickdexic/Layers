<!DOCTYPE html>
<html>
<head>
    <title>Manual Layers Editor Test</title>
    <script src="//localhost:8080/resources/jquery/jquery.js"></script>
    <script src="//localhost:8080/resources/mediawiki/mediawiki.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>Manual Layers Editor Test</h1>
    <div id="status"></div>
    <div id="editor-container" style="width: 100%; height: 500px; border: 1px solid #ccc; position: relative;"></div>
    
    <script>
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const div = document.createElement('div');
            div.className = 'status ' + type;
            div.innerHTML = new Date().toLocaleTimeString() + ': ' + message;
            status.appendChild(div);
            console.log(message);
        }

        // Mock MediaWiki environment
        window.mw = window.mw || {
            config: {
                get: function(key) {
                    if (key === 'wgLayersEditorInit') {
                        return {
                            filename: 'ImageTest02.jpg',
                            imageUrl: 'http://localhost:8080/images/ImageTest02.jpg'
                        };
                    }
                    return null;
                }
            },
            message: function(key) {
                return {
                    text: function() {
                        return key; // Just return the key as the text for simplicity
                    }
                };
            },
            hook: function(name) {
                return {
                    add: function(fn) {
                        // For the test, we'll manually call this later
                        if (name === 'layers.editor.init') {
                            window.layersInitHook = fn;
                        }
                    },
                    fire: function(data) {
                        if (window.layersInitHook) {
                            window.layersInitHook(data);
                        }
                    }
                };
            },
            Api: function() {
                return {
                    get: function() {
                        return $.Deferred().resolve({
                            layersinfo: {
                                layerset: {
                                    data: { layers: [] }
                                }
                            }
                        });
                    },
                    postWithToken: function() {
                        return $.Deferred().resolve({
                            layerssave: { success: true }
                        });
                    }
                };
            },
            notify: function(message, options) {
                log(message, options && options.type || 'info');
            },
            log: {
                log: function(msg) { console.log('MW Log:', msg); },
                error: function(msg) { console.error('MW Error:', msg); }
            }
        };

        // Load the editor scripts
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function loadEditorScripts() {
            try {
                log('Loading CanvasManager...', 'info');
                await loadScript('//localhost:8080/extensions/Layers/resources/ext.layers.editor/CanvasManager.js');
                log('CanvasManager loaded: ' + !!window.CanvasManager, window.CanvasManager ? 'success' : 'error');

                log('Loading LayerPanel...', 'info');
                await loadScript('//localhost:8080/extensions/Layers/resources/ext.layers.editor/LayerPanel.js');
                log('LayerPanel loaded: ' + !!window.LayerPanel, window.LayerPanel ? 'success' : 'error');

                log('Loading Toolbar...', 'info');
                await loadScript('//localhost:8080/extensions/Layers/resources/ext.layers.editor/Toolbar.js');
                log('Toolbar loaded: ' + !!window.Toolbar, window.Toolbar ? 'success' : 'error');

                log('Loading LayersEditor...', 'info');
                await loadScript('//localhost:8080/extensions/Layers/resources/ext.layers.editor/LayersEditor.js');
                log('LayersEditor loaded: ' + !!window.LayersEditor, window.LayersEditor ? 'success' : 'error');

                if (window.LayersEditor && window.CanvasManager && window.LayerPanel && window.Toolbar) {
                    log('All scripts loaded successfully!', 'success');
                    
                    // Try to manually initialize the editor
                    log('Attempting to initialize editor...', 'info');
                    
                    try {
                        if (window.layersInitHook) {
                            window.layersInitHook({
                                filename: 'ImageTest02.jpg',
                                imageUrl: 'http://localhost:8080/images/ImageTest02.jpg',
                                container: document.getElementById('editor-container')
                            });
                            log('Editor initialization hook called', 'success');
                        } else {
                            // Manual initialization
                            const editor = new window.LayersEditor({
                                filename: 'ImageTest02.jpg',
                                imageUrl: 'http://localhost:8080/images/ImageTest02.jpg',
                                container: document.getElementById('editor-container')
                            });
                            log('Editor manually initialized', 'success');
                        }
                    } catch (error) {
                        log('Error initializing editor: ' + error.message, 'error');
                    }
                } else {
                    log('Some scripts failed to load', 'error');
                }
            } catch (error) {
                log('Error loading scripts: ' + error.message, 'error');
            }
        }

        // Start loading when page is ready
        $(document).ready(function() {
            log('Document ready, starting script loading...', 'info');
            loadEditorScripts();
        });
    </script>
</body>
</html>
