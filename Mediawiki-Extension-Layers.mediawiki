{{Extension
|image           = ExtensionLayersEditor.png
|name            = Layers
|status          = stable
|type1           = media
|type2           = parser function
|type3           = special
|type4           = page action
|type5           = api
|author          = [[User:Pvodrazka|Paul Vodrazka]]
|version         = 1.5.57
|update          = 2026-02-13
|download        = {{GithubDownload|slickdexic|Layers}}
|readme          = [https://github.com/slickdexic/Layers/blob/main/README.md README]
|changelog       = [https://github.com/slickdexic/Layers/blob/main/CHANGELOG.md CHANGELOG]
|license         = GPL-2.0-or-later
|tags            = {{bulleted list|{{tag|annotation|o}}|{{tag|canvas|o}}|{{tag|drawing|o}}|{{tag|image editor|o}}|{{tag|image markup|o}}|{{tag|non-destructive|o}}}}
|mediawiki       = >= 1.44.0
|php             = >= 8.1
|needs-updatephp = yes
|table1          = layer_assets
|table2          = layer_set_usage
|table3          = layer_sets
|rights          = {{bulleted list|editlayers|managelayerlibrary}}
|parameters      = {{bulleted list|$wgLayersEnable|$wgLayersDebug|$wgLayersMaxBytes|$wgLayersMaxImageBytes|$wgLayersMaxLayerCount|$wgLayersMaxNamedSets|$wgLayersMaxRevisionsPerSet|$wgLayersDefaultSetName|$wgLayersUseBinaryOverlays|$wgLayersDefaultFonts|$wgLayersMaxImageSize|$wgLayersThumbnailCache|$wgLayersImageMagickTimeout|$wgLayersMaxImageDimensions}}
|hook1           = BeforePageDisplay
|hook2           = BitmapHandlerTransform
|hook3           = FileDeleteComplete
|hook4           = ImageBeforeProduceHTML
|hook5           = ImagePageAfterImageLinks
|hook6           = LinkerMakeMediaLinkFile
|hook7           = LoadExtensionSchemaUpdates
|hook8           = MakeGlobalVariablesScript
|hook9           = ParserBeforeInternalParse
|hook10          = ParserFirstCallInit
|hook11          = ParserMakeImageParams
|hook12          = SkinTemplateNavigation::Universal
|hook13          = ThumbnailBeforeProduceHTML
|description     = A professional-grade, non-destructive image annotation system with 17 drawing tools, 5,116 built-in shapes (ISO 7010, IEC 60417, ISO 7000, GHS, ECB, ANSI), '''Slide Mode''' for standalone graphics, curved arrows, live preview, layer folders, style presets, named layer sets, and full keyboard accessibility.
}}

The '''Layers''' extension is a modern, non-destructive image annotation and editing tool for MediaWiki. It enables users to add captions, callouts, highlights, shapes, and freehand drawings to images '''without altering the original file'''.

All edits are stored as validated JSON and rendered client-side for precise positioning. The system fully integrates into MediaWiki's file pages and parser. Click the {{key press|'''Edit layers'''}} tab on any image's <code>File:</code> page to access the editor.

== Why Layers? ==
* '''Professional Tools:''' 15 [[#Drawing Tools|drawing tools]], style presets, live preview, industry-standard alignment, a rich selection of [[#Annotation Tools|built-in shapes and emoji]], and '''[[#Slide Mode (v1.5.22+)|Slide Mode]]''' for standalone graphics—everything needed to annotate like a pro.
* '''Non-Destructive:''' Original images are never modified. Annotations are stored separately and can be versioned or removed at any time.
* '''Accessible:''' WCAG 2.1 compliant with [[#Keyboard Shortcuts|full keyboard navigation]], screen reader support, and high-contrast indicators.

== Use Cases ==
{| class="wikitable"
! Use Case !! Example !! Features Used
|-
| '''Educational Content''' || Label anatomy diagrams, annotate historical photos || Callouts, arrows, text boxes, named sets for different topics
|-
| '''Technical Documentation''' || Highlight UI elements, show click sequences || Numbered labels, curved arrows, blur to de-emphasize
|-
| '''Step-by-Step Guides''' || Multi-step tutorials on a single image || Named layer sets ("Step 1", "Step 2"), revision history
|-
| '''Collaborative Review''' || Multiple annotators on the same image || Named layer sets per reviewer, revision tracking
|-
| '''Maps & Geography''' || Mark locations, draw routes, highlight regions || Shapes, arrows, polygon tool, opacity controls
|-
| '''Scientific Imagery''' || Label specimens, mark measurement points || Text boxes, arrows, style presets for consistency
|}

== Slide Mode (v1.5.22+) ==
'''Create standalone canvas graphics without requiring a base image.''' Slides are perfect for diagrams, infographics, flowcharts, and presentations. Like images, slides support '''multiple named layer sets''' for different annotation variations.

=== Slide Syntax ===
<syntaxhighlight lang="wikitext">
{{#Slide: MySlide}}
<!-- Render slide "MySlide" (default layer set) -->

{{#Slide: MySlide | layerset=annotations}}
<!-- Render specific named layer set -->

{{#Slide: MySlide | size=800x600}}
<!-- Render at specific display size -->

{{#Slide: MySlide | canvas=1920x1080}}
<!-- Create with specific canvas size -->

{{#Slide: MySlide | size=800x600 | noedit}}
<!-- no edit button overlay -->
</syntaxhighlight>

=== Slide Parameters ===
{| class="wikitable"
! Parameter !! Description !! Example
|-
| <code>layerset</code> || Named layer set to display (default: "default") || <code>layerset=anatomy</code>
|-
| <code>canvas</code> || Canvas size in pixels || <code>canvas=1920x1080</code>
|-
| <code>size</code> || Display size on page || <code>size=800x600</code>
|-
| <code>noedit</code> || disable edit button || <code>noedit</code>
|}

=== Slide Management ===
{| class="wikitable"
! Feature !! Description
|-
| <code>Special:Slides</code> || Browse, search, create, and delete slides with a modern grid interface
|-
| <code>Special:EditSlide/SlideName</code> || Direct editor access for a specific slide
|-
| Custom canvas sizes || Any size from 100×100 to 4096×4096 pixels
|-
| Background colors || Any CSS color or transparent
|-
| Instant refresh || Changes appear immediately after saving (no page reload needed)
|}

== Installation ==
=== Branch Selection ===
{{Note|text=MediaWiki 1.39 LTS reached end-of-life on December 31, 2025. The REL1_43 branch provides full feature parity with main and is recommended for MediaWiki 1.43 users.}}

{| class="wikitable"
! MediaWiki Version !! Branch !! Current Version
|-
| 1.44+ || <code>main</code> || 1.5.57
|-
| 1.43.x (LTS) || <code>[https://github.com/slickdexic/Layers/tree/REL1_43 REL1_43]</code> || 1.5.57
|-
| 1.39 - 1.42 || <code>[https://github.com/slickdexic/Layers/tree/REL1_39 REL1_39]</code> || 1.5.57
|}
{{ExtensionInstall
|registration=required
|db-update=yes
|custom-steps=
*Developers considering running tests, linting, etc. should run <code>composer install</code> and <code>npm install</code> within the newly created <code>Layers</code> directory.
|download-link=Download the suitable binary for your MediaWiki version (either [https://github.com/slickdexic/Layers/archive/refs/heads/main.zip main], [https://github.com/slickdexic/Layers/archive/refs/heads/REL1_43.zip REL1_43] or [https://github.com/slickdexic/Layers/archive/refs/heads/REL1_39.zip REL1_39])
}}

== Configuration ==
=== Parameters ===
{| class="wikitable"
! Variable !! Type !! Default !! Description
|-
| <code>$wgLayersEnable</code> || boolean || <code>true</code> || Master switch for Layers.
|-
| <code>$wgLayersDebug</code> || boolean || <code>false</code> || Enable verbose debug logging.
|-
| <code>$wgLayersMaxLayerCount</code> || integer || <code>100</code> || Max layers per set.
|-
| <code>$wgLayersMaxNamedSets</code> || integer || <code>15</code> || Max named sets per image.
|-
| <code>$wgLayersMaxRevisionsPerSet</code> || integer || <code>50</code> || Historical revisions to keep.
|-
| <code>$wgLayersMaxImageBytes</code> || integer || <code>1048576</code> || Max size for imported image layers.
|-
| <code>$wgLayersMaxBytes</code> || integer || <code>2097152</code> || Max JSON size for a single layer set.
|-
| <code>$wgLayersDefaultSetName</code> || string || <code>"default"</code> || Default named set when none is specified.
|-
| <code>$wgLayersUseBinaryOverlays</code> || boolean || <code>false</code> || Enable legacy binary overlay files.
|-
| <code>$wgLayersDefaultFonts</code> || array || (see extension.json) || Allowed fonts list for the editor.
|-
| <code>$wgLayersMaxImageSize</code> || integer || <code>4096</code> || Max image size for editing (px).
|-
| <code>$wgLayersThumbnailCache</code> || boolean || <code>true</code> || Cache composite thumbnails.
|-
| <code>$wgLayersImageMagickTimeout</code> || integer || <code>30</code> || ImageMagick timeout (seconds).
|-
| <code>$wgLayersMaxImageDimensions</code> || integer || <code>8192</code> || Max width/height for processing.
|}

=== Permissions ===
{| class="wikitable"
! Right !! Description !! Default Groups
|-
| <code>editlayers</code> || Create and edit layer sets || <code>user</code>
|-
| <code>managelayerlibrary</code> || Manage global layer library || <code>sysop</code>
|}

== Key Features ==

=== Annotation Tools ===
* '''Callouts & Speech Bubbles''': Professional callouts with draggable tail positioning, three tail styles (triangle, curved, line), and rounded corners—perfect for tutorials and explanations.
* '''Curved Arrows''': Arrows support curved paths via a draggable control point, with configurable head types (arrow, circle, diamond, triangle) and line styles (solid, dashed, dotted).
* '''Text & Text Boxes''': Simple click-to-place text or advanced text boxes with word wrap, vertical alignment, padding, and corner radius.
* '''Shape Library (5,116 Shapes)''': Built-in library with 12 categories including arrows, basic shapes, callouts, flowchart, [[w:ISO 7010|ISO 7010]] safety symbols, [https://www.iso.org/obp/ui/#iso:pub:PUB400008:en IEC 60417], ISO 7000, [[w:GHS hazard pictograms|GHS]], ECB, math, and more. All shapes render as crisp SVG vectors.
* '''Emoji Library (2,817 Emoji)''': Google Noto Color Emoji library with 19 categories (smileys, gestures, people, animals, food, travel, sports, and more). Lazy-loaded SVG thumbnails for fast browsing.

=== Visual Effects ===
* '''Blur Fill''': Apply a "frosted glass" blur effect to any shape—blur what's beneath instead of using a solid fill.
* '''Shadow & Glow''': Add drop shadows with configurable blur, offset, and spread. Glow effects for emphasis.
* '''Blend Modes''': Standard blend modes (multiply, screen, overlay, etc.) for professional compositing.
* '''Opacity Controls''': Independent fill and stroke opacity for fine-tuned transparency.

=== Layer Management ===
* '''Layer Folders''': Group layers into collapsible folders for organization. Visibility and lock states cascade to children.
* '''Named Layer Sets''': Create multiple annotation sets per image (e.g., "default", "anatomy-labels", "step-by-step").
* '''Revision History''': Automatically tracks up to 50 revisions per layer set with one-click restore.
* '''Lock & Visibility''': Lock layers to prevent accidental edits; toggle visibility for complex compositions.

=== Professional Workflow ===
* '''Style Presets''': Save and reuse style configurations (colors, stroke width, fonts) per tool type.
* '''Smart Guides''': Snap to edges and centers of other objects with visual alignment guides.
* '''Key Object Alignment''': Industry-standard alignment matching Adobe Illustrator—last selected object becomes the alignment anchor.
* '''Distribute Tools''': Evenly space selected layers horizontally or vertically.

=== Real-Time Editing ===
* '''Live Color Preview''': Canvas updates in real-time as colors are selected in the color picker.
* '''Live Article Preview''': Layer changes appear immediately on article pages after saving—no page reload needed.
* '''Instant Feedback''': All property changes (stroke width, font size, opacity) update the canvas immediately.
* '''Hover Overlay Actions''': Edit/View icons appear on hover over layered images—respects <code>editlayers</code> permission for edit button visibility.

=== Integration ===
* '''Import Images''': Add external images as layers (PNG, JPG, GIF, WebP).
* '''Export as PNG''': Download the annotated image as a single PNG file.
* '''InstantCommons Support''': Works seamlessly with files from [[w:Wikimedia Commons|Wikimedia Commons]] and other foreign repositories.
* '''Vector 2022 Dark Mode''': Full support for MediaWiki's {{ll|Skin:Vector/2022|2=Vector 2022 skin}} night mode.

=== Deep Linking (v1.2.0+) ===
Control how users interact with layered images using the <code>layerslink</code> parameter:

{| class="wikitable"
! Parameter !! Behavior !! Use Case
|-
| <code>layerslink=viewer</code> || Opens fullscreen lightbox viewer || Enlarged view for detailed inspection
|-
| <code>layerslink=editor</code> || Opens layer editor directly || Quick access from article to editing
|-
| <code>layerslink=editor-newtab</code> || Opens editor in new browser tab || Edit without losing article context
|-
| <code>layerslink=editor-modal</code> || Opens editor in iframe overlay || Perfect for {{ll|Extension:Page Forms|nsp=0}} integration
|}

{{note|text=Please note that {{para|layerslink|editor-modal}} requires <code>{{ll|1=Manual:$wgEditPageFrameOptions|2=$wgEditPageFrameOptions}} {{=}} 'SAMEORIGIN';</code> in {{ll|1=LocalSettings.php}}.}}

'''Example usage:'''
<syntaxhighlight lang="wikitext">
[[File:Anatomy.png|thumb|layerset=anatomy|layerslink=viewer]]
[[File:Diagram.png|thumb|layerset=labels|layerslink=editor]]
'layers=' was changed to 'layerset=' to be more consistent with the terminology used in the editor.
'layers=' is still supported for backwards compatibility.
</syntaxhighlight>

== Drawing Tools ==
{| class="wikitable"
! Tool !! Shortcut !! Purpose !! Key Features
|-
| Pointer || {{key press|V}} || Select/manipulate || Multi-select, resize, rotate, Key Object alignment
|-
| Text || {{key press|T}} || Simple Text || Click to place, inline editing
|-
| Text Box || {{key press|X}} || Advanced Text || Word wrap, alignment, padding, corner radius
|-
| Callout || {{key press|B}} || Speech Bubbles || Draggable tail, 3 tail styles, rounded corners
|-
| Pen || {{key press|P}} || Freehand || Smooth paths, adjustable stroke
|-
| Rectangle || {{key press|R}} || Basic Shape || Adjustable stroke, fill, corner radius
|-
| Circle || {{key press|C}} || Basic Shape || Perfect circles with stroke and fill
|-
| Ellipse || {{key press|E}} || Basic Shape || Oval shapes with independent radii
|-
| Polygon || {{key press|Y}} || Complex Shape || Configurable sides, rounded corners
|-
| Star || {{key press|S}} || Complex Shape || Configurable points and radii
|-
| Arrow || {{key press|A}} || Annotations || Configurable head types, curved paths, line styles
|-
| Line || {{key press|L}} || Annotations || Simple lines with adjustable stroke
|-
| Marker || {{key press|M}} || Sequence Markers || Numbered/lettered markers with optional leader lines
|-
| Dimension || {{key press|D}} || Measurements || Technical dimension annotations with tick marks
|-
| Custom Shape || — || Shape Library || Arrows, symbols, flowchart shapes, and more
|-
| Emoji || — || Emoji Library || 2,817 Noto Color Emoji in 19 categories
|}

== Keyboard Shortcuts ==
Full keyboard accessibility with over 20 shortcuts:

{| class="wikitable"
! Action !! Shortcut !! Action !! Shortcut
|-
| Pointer Tool || {{key press|V}} || Undo || {{key press|Ctrl}}+{{key press|Z}}
|-
| Text Tool || {{key press|T}} || Redo || {{key press|Ctrl}}+{{key press|Shift}}+{{key press|Z}}
|-
| Arrow Tool || {{key press|A}} || Delete Layer || {{key press|Delete}} or {{key press|Backspace}}
|-
| Rectangle Tool || {{key press|R}} || Duplicate || {{key press|Ctrl}}+{{key press|D}}
|-
| Circle Tool || {{key press|C}} || Group Layers || {{key press|Ctrl}}+{{key press|G}}
|-
| Ellipse Tool || {{key press|E}} || Ungroup || {{key press|Ctrl}}+{{key press|Shift}}+{{key press|G}}
|-
| Polygon Tool || {{key press|Y}} || Select All || {{key press|Ctrl}}+{{key press|A}}
|-
| Star Tool || {{key press|S}} || Toggle Smart Guides || {{key press|;}}
|-
| Pen Tool || {{key press|P}} || Save || {{key press|Ctrl}}+{{key press|S}}
|-
| Marker Tool || {{key press|M}} || Dimension Tool || {{key press|D}}
|}

== Technical Details ==
* '''Performance:''' Architecture splits the lightweight Viewer (~3,300 lines including overlay) from the Editor (~113k lines including generated shape/emoji data).
* '''Stability:''' 11,122 Jest tests (162 suites) with 95.19% statement coverage and 84.96% branch coverage.
* '''Security:''' Property whitelisting (50+ fields), CSRF protection, and strict text sanitization.
* '''Accessibility:''' WCAG 2.1 compliant with <code>prefers-reduced-motion</code> support, ARIA live regions, and skip links.

== See also ==
* [https://github.com/slickdexic/Layers/blob/main/CHANGELOG.md Full Changelog]
* [https://github.com/slickdexic/Layers/wiki Project Wiki]
