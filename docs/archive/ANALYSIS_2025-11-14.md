# Code Analysis - Text Rotation Issue
**Date**: November 14, 2025  
**Analyst**: GitHub Copilot  
**Status**: ANALYSIS ONLY - NO CHANGES MADE YET

## User-Reported Issues

1. **Text rotation**: Text position relative to selection box "goes way out of position"
2. **Stroke width capped at 10px**: Text stroke width limited, shapes allow 200px
3. **Font size capped at 200px**: User questions if this limit is necessary
4. **No stroke opacity**: Unclear what this means - shapes HAVE stroke opacity
5. **Effects opacity affects entire layer**: Labeled just "Opacity" but changes whole layer
6. **Drop shadow spread does nothing**: Control exists but has no effect

## Root Cause Analysis

### Issue 1: Text Rotation Displacement

**File**: `resources/ext.layers.editor/CanvasManager.js`

**Problem Location 1: `getLayerBounds()` for text (lines ~2995-3005)**
```javascript
case 'text':
    var textX = layer.x || 0;
    var textY = layer.y || 0;
    var fontSize = layer.fontSize || 16;
    var text = layer.text || '';

    // Estimate text dimensions
    this.ctx.save();
    this.ctx.font = fontSize + 'px ' + ( layer.fontFamily || 'Arial' );
    var metrics = this.ctx.measureText( text );
    this.ctx.restore();

    return {
        x: textX,
        y: textY - fontSize,  // ← WRONG: Subtracts fontSize
        width: metrics.width,  // ← WRONG: Single line only
        height: fontSize       // ← WRONG: Single line only
    };
```

**Problem Location 2: `drawText()` (lines ~4890-4940)**
```javascript
// Calculate total text dimensions for proper centering
var totalTextWidth = 0;
var totalTextHeight = lines.length * lineHeight;  // Multi-line!

// Find the longest line for centering calculations
for ( var i = 0; i < lines.length; i++ ) {
    var lineMetrics = this.ctx.measureText( lines[ i ] );
    if ( lineMetrics.width > totalTextWidth ) {
        totalTextWidth = lineMetrics.width;
    }
}

// Calculate text center for rotation
var centerX = x + ( totalTextWidth / 2 );
var centerY = y + ( totalTextHeight / 2 );  // Uses y directly, not y-fontSize!
```

**THE MISMATCH**:
- `getLayerBounds()` returns: `y: textY - fontSize, height: fontSize` (single line)
- `drawText()` calculates center as: `y + (lines.length * lineHeight) / 2` (multi-line)
- Selection box rotates around `(x + width/2, (textY-fontSize) + fontSize/2)`
- Text rotates around `(x + width/2, textY + (lines*lineHeight)/2)`
- **These are DIFFERENT center points!**

**Why `textY - fontSize` was used**: 
- Text is drawn from the baseline, not top-left
- For single-line text, baseline is roughly at `y + fontSize`
- So to get top of text: `y - fontSize` seemed logical
- But this breaks with multi-line text and doesn't match `drawText()`

**Correct Fix**:
- Make `getLayerBounds()` calculate text dimensions EXACTLY like `drawText()`
- Use same multi-line wrapping logic
- Return same `y` position (not `y - fontSize`)
- Return same height (lines.length * lineHeight, not fontSize)

### Issue 2: Text Stroke Width Limit

**File**: `resources/ext.layers.editor/LayerPanel.js`, line ~1259

```javascript
addInput( { 
    label: t( 'layers-prop-stroke-width', 'Text Stroke Width' ), 
    type: 'number', 
    value: layer.textStrokeWidth || 0, 
    min: 0, 
    max: 10,  // ← Limited to 10
    step: 1, 
    onChange: function ( v ) { 
        self.editor.updateLayer( layer.id, { textStrokeWidth: parseInt( v, 10 ) } ); 
    } 
} );
```

**Comparison**: Shapes stroke width (line ~1282):
```javascript
addInput( { 
    label: t( 'layers-prop-stroke-width', 'Stroke Width' ), 
    type: 'number', 
    value: layer.strokeWidth || 1, 
    min: 0, 
    max: 200,  // ← Shapes allow 200
    step: 1, 
    onChange: function ( v ) { 
        var val = Math.max( 0, Math.min( 200, parseInt( v, 10 ) ) ); 
        self.editor.updateLayer( layer.id, { strokeWidth: val } ); 
    } 
} );
```

**Analysis**: No technical reason for this difference. Text stroke is just an outline around text characters. Should be increased to match shapes (200px).

### Issue 3: Font Size Cap at 200px

**File**: `resources/ext.layers.editor/LayerPanel.js`, line ~1257
```javascript
addInput( { 
    label: t( 'layers-prop-font-size', 'Font Size' ), 
    type: 'number', 
    value: layer.fontSize || 16, 
    min: 6, 
    max: 200,  // ← UI limit
    step: 1, 
    prop: 'fontSize', 
    onChange: function ( v ) { 
        var fs = Math.max( 6, Math.min( 200, parseInt( v, 10 ) ) ); 
        self.editor.updateLayer( layer.id, { fontSize: fs } ); 
    } 
} );
```

**File**: `resources/ext.layers.editor/CanvasManager.js`, `calculateTextResize()`, line ~1306
```javascript
// Clamp font size to reasonable bounds (minimum 6px for readability)
newFontSize = Math.max( 6, Math.min( 144, newFontSize ) );  // ← Resize limit 144!
```

**File**: `src/Validation/ServerSideLayerValidator.php`, line ~100
```javascript
'fontSize' => ['min' => 1, 'max' => 200],  // ← Server allows 200
```

**Analysis**: 
- UI input allows 200
- Server allows 200
- But resize dragging is capped at 144 (inconsistent!)
- **Is 200px necessary?** For large images (posters, banners), yes. But there's no validation against image size.
- **Should there be a limit?** Yes, to prevent performance issues and unreasonable data sizes.
- **Recommendation**: Keep 200px limit but make all three consistent.

### Issue 4: No Stroke Opacity (UNCLEAR)

**Finding**: Shapes DO have stroke opacity (line ~1284):
```javascript
addSliderInput( { 
    label: t( 'layers-prop-stroke-opacity', 'Stroke Opacity' ), 
    value: ( layer.strokeOpacity != null ) ? Math.round( layer.strokeOpacity * 100 ) : 100, 
    min: 0, max: 100, step: 1, 
    onChange: function ( v ) { 
        self.editor.updateLayer( layer.id, { strokeOpacity: v / 100 } ); 
    } 
} );
```

This control is excluded for text layers (line 1281: `if ( layer.type !== 'text' )`).

**Question for user**: Do you want stroke opacity for TEXT strokes, or is this a misunderstanding?

### Issue 5: Opacity Label Confusion

**File**: `resources/ext.layers.editor/LayerPanel.js`, line ~1290

```javascript
var layerOpacityValue = ( layer.opacity != null ) ? layer.opacity : 1; 
layerOpacityValue = Math.round( layerOpacityValue * 100 );
addSliderInput( { 
    label: t( 'layers-prop-opacity', 'Layer Opacity' ),  // ← Says "Layer Opacity"
    value: layerOpacityValue, 
    min: 0, max: 100, step: 1, 
    onChange: function ( v ) { 
        self.editor.updateLayer( layer.id, { opacity: v / 100 } ); 
    } 
} );
```

**Analysis**: 
- Property name: `layer.opacity`
- Label: "Layer Opacity"
- Section: "Effects"
- **This IS correctly labeled** as "Layer Opacity" in the code
- **It SHOULD affect the entire layer** (that's what layer compositing means)
- **User concern**: Why is it under "Effects" section?

**Other opacity controls**:
- `fillOpacity`: Affects only the fill color transparency
- `strokeOpacity`: Affects only the stroke transparency
- `opacity`: Affects the entire rendered layer after compositing

**Recommendation**: Either:
1. Move layer opacity to a different section (not "Effects"), OR
2. Add a comment in UI clarifying what each opacity does

### Issue 6: Drop Shadow Spread Does Nothing

**Status:** ✅ FIXED (December 2025)

**Original Problem:**
The shadowSpread property was saved to layers but never rendered. HTML5 Canvas 2D API doesn't natively support shadow spread.

**Solution Implemented:**
Shadow spread is now implemented in `LayerRenderer.js` using an offscreen canvas technique:

1. **`drawSpreadShadow()`** - For filled shapes: draws an expanded filled shape with shadow on a temp canvas, erases the shape portion, composites just the shadow
2. **`drawSpreadShadowStroke()`** - For strokes: draws a thicker stroke with shadow on a temp canvas, erases the stroke portion, composites just the shadow

**Key Implementation Details:**
- Uses FAR_OFFSET technique (5000px) to separate shape from shadow on temp canvas
- Draws SEPARATE shadows for fill and stroke components to match spread=0 behavior
- Fill shadow uses `fillOpacity`, stroke shadow uses `strokeOpacity`
- When fill is transparent + stroke is opaque → frame-shaped shadow (matches CSS box-shadow behavior)

**Files Modified:**
- `resources/ext.layers.shared/LayerRenderer.js` - Core implementation
  - `drawSpreadShadow()` - Fill shadow with opacity parameter
  - `drawSpreadShadowStroke()` - Stroke shadow with opacity parameter
  - All shape functions updated: drawRectangle, drawCircle, drawEllipse, drawPolygon, drawStar, drawArrow
  - Line and Path already correctly used stroke-only shadow

## Proposed Changes

### CHANGE 1: Fix Text Rotation (HIGH PRIORITY)
**File**: `resources/ext.layers.editor/CanvasManager.js`
**Function**: `getLayerBounds()`
**Action**: Replace single-line text measurement with multi-line calculation matching `drawText()`

### CHANGE 2: Increase Text Stroke Width Limit
**File**: `resources/ext.layers.editor/LayerPanel.js`
**Line**: ~1259
**Action**: Change `max: 10` to `max: 200`

### CHANGE 3: Fix Font Size Resize Limit
**File**: `resources/ext.layers.editor/CanvasManager.js`
**Function**: `calculateTextResize()`
**Line**: ~1306
**Action**: Change `Math.min( 144, ...)` to `Math.min( 200, ...)`

### CHANGE 4: Clarify Layer Opacity Label (LOW PRIORITY)
**File**: `resources/ext.layers.editor/LayerPanel.js`
**Line**: ~1290
**Action**: Consider adding tooltip or renaming section

### ~~CHANGE 5: Remove Shadow Spread Control~~ (NO LONGER NEEDED)
**Status:** ✅ Shadow spread is now fully implemented (December 2025)
**Action:** None - the control works correctly

## Code Comments to Add

All changes will include inline comments explaining:
1. What was changed
2. Why it was changed
3. What problem it fixes
4. Date and reference to this analysis

Example format:
```javascript
// FIX 2025-11-14: Match drawText() multi-line calculation
// Previously used single-line estimate (y: textY-fontSize, height: fontSize)
// which caused rotation center mismatch. See ANALYSIS_2025-11-14.md
```

## Next Steps

1. User reviews this analysis
2. User confirms which changes to make
3. Changes implemented ONE AT A TIME
4. Each change tested before next
5. Each change documented with inline comments

**NO CHANGES MADE YET - AWAITING USER APPROVAL**
