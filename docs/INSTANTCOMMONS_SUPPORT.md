# InstantCommons / Foreign File Support

**Added in:** v1.4.5 (January 2026)  
**Updated:** v1.4.6 (January 2026) â€” TIFF support, SHA1 fallback lookup  
**GitHub Issue:** #34

This document describes the Layers extension's support for files from foreign repositories such as Wikimedia Commons via InstantCommons.

---

## Overview

The Layers extension now fully supports annotating files from foreign repositories (InstantCommons, ForeignDB, etc.). This means users can:

- Create, edit, save, and delete layer annotations on Commons files
- Use `layerset=` and `layerslink=` wikitext parameters with foreign files
- Link directly to the editor for foreign files
- Annotate non-web image formats (TIFF, BMP) using automatic thumbnail conversion

---

## Supported File Formats

In addition to standard web formats (JPEG, PNG, GIF, WebP, SVG), the extension now supports:

| Format | Extension | Notes |
|--------|-----------|-------|
| TIFF | `.tif`, `.tiff` | Common on Wikimedia Commons for archival images |
| BMP | `.bmp` | Converted via MediaWiki thumbnails |

Non-web formats are automatically loaded using MediaWiki's `Special:Redirect/file` endpoint with a width parameter, which returns a web-compatible thumbnail.

---

## How It Works

### Foreign File Detection

The extension detects foreign files using the `isForeignFile()` helper method, which checks for:

1. **Class type**: `ForeignAPIFile` or `ForeignDBFile` instances
2. **Class name**: Any class containing "Foreign" in its name
3. **Repository check**: Files where `$file->getRepo()->isLocal()` returns `false`

### SHA1 Fallback Identifier

Foreign files often don't provide a SHA1 hash via the API. The extension handles this by:

1. First attempting to get the native SHA1: `$file->getSha1()`
2. If empty and the file is foreign, generating a stable fallback: `'foreign_' . sha1($title->getDBkey())`

This ensures consistent database lookups across all operations.

**Migration Note:** For layer sets saved before v1.4.5 (which may have used empty SHA1), the API endpoints now include a fallback lookup via `LayersDatabase::findSetSha1()` that searches by image name and set name only, then uses whatever SHA1 is stored in the database.

### Content Security Policy (CSP)

When editing a foreign file, the extension dynamically adds the foreign file's origin (e.g., `https://upload.wikimedia.org`) to the Content Security Policy's `img-src` directive. This allows the browser to load the image in the editor canvas.

**How it works:**

1. On file pages (`NS_FILE`), the `BeforePageDisplay` hook detects the file
2. If the file is foreign, extract the origin from `$file->getUrl()`
3. Add the origin to the CSP `img-src` directive

---

## Configuration

No special configuration is required. The extension automatically handles foreign files when:

- `$wgUseInstantCommons = true;` is set in LocalSettings.php
- Or any other foreign file repository is configured

---

## Wikitext Usage

Foreign files work identically to local files:

```wikitext
<!-- Display layers on a Commons file -->
[[File:Example_from_Commons.jpg|layerset=on]]

<!-- Link to editor for a Commons file -->
[[File:Example_from_Commons.jpg|layerslink=editor]]

<!-- Named layer set -->
[[File:Example_from_Commons.jpg|layerset=anatomy|layerslink=editor:anatomy]]
```

---

## Technical Details

### Files Modified for Foreign File Support

The following files include `getFileSha1()` and `isForeignFile()` helper methods:

| File | Purpose |
|------|---------|
| `ApiLayersInfo.php` | API: Read layer data |
| `ApiLayersSave.php` | API: Save layer data |
| `ApiLayersDelete.php` | API: Delete layer sets |
| `ApiLayersRename.php` | API: Rename layer sets |
| `EditLayersAction.php` | Editor page action |
| `Hooks.php` | Core hooks (file deletion cleanup, CSP) |
| `LayerInjector.php` | Inject layer data into image params |
| `ImageLinkProcessor.php` | Process image links |
| `ThumbnailProcessor.php` | Process thumbnails |
| `LayeredFileRenderer.php` | Render layered files |
| `LayersFileTransform.php` | File transform hook |
| `ThumbnailRenderer.php` | Generate layered thumbnails |
| `WikitextHooks.php` | Wikitext parameter parsing |

### Database Schema

No database changes required. Foreign files use the existing `layer_sets` table with:

- `ls_img_name`: The filename (same as Commons)
- `ls_img_sha1`: Either the native SHA1 or the fallback `foreign_xxxxx` identifier

### Editor Image Loading

For foreign files, the editor uses a local proxy URL:

```
/index.php/Special:Redirect/file/Filename.jpg
```

This URL is generated by `EditLayersAction::getLocalRedirectUrl()` and avoids CORS issues when loading the image into the canvas.

**Note:** `Special:Redirect/file` returns a 301 redirect to the actual Commons URL, so the CSP must include the foreign origin for the image to load successfully.

---

## Troubleshooting

### Image not loading in editor

**Symptom:** Editor opens but canvas shows placeholder or error.

**Cause:** CSP blocking the foreign image URL.

**Solution:** The extension should automatically add the foreign origin to CSP. If not working:

1. Check browser console for CSP errors
2. Verify the file is recognized as foreign (check `layers.log` for "isForeign=yes")
3. Clear browser cache and try again

### Layers not saving

**Symptom:** Save appears to succeed but layers don't persist.

**Cause:** SHA1 mismatch between save and load operations.

**Solution:** Check `layers.log` for SHA1 values. Foreign files should show `foreign_xxxxx` identifiers consistently.

### layerslink not working

**Symptom:** Clicking image goes to File: page instead of editor.

**Cause:** Filename normalization issue (spaces vs underscores).

**Solution:** Fixed in v1.4.5. Ensure you're running the latest version.

---

## See Also

- [WIKITEXT_USAGE.md](WIKITEXT_USAGE.md) - Full wikitext parameter reference
- [CSP_GUIDE.md](CSP_GUIDE.md) - Content Security Policy configuration
- [API.md](API.md) - API reference for layer operations
