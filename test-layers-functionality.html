<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layers Extension Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-image {
            max-width: 400px;
            border: 2px solid #ccc;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        code {
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <h1>Layers Extension Test Page</h1>
    
    <div class="test-container">
        <h2>Test 1: MediaWiki Environment</h2>
        <div id="mw-test" class="status info">Testing MediaWiki availability...</div>
    </div>

    <div class="test-container">
        <h2>Test 2: Layers Module Loading</h2>
        <div id="module-test" class="status info">Testing module loading...</div>
    </div>

    <div class="test-container">
        <h2>Test 3: LayersViewer Functionality</h2>
        <div id="viewer-test" class="status info">Testing LayersViewer...</div>
        
        <!-- Test image with layer data -->
        <div style="position: relative; display: inline-block;">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzQ0ODhkZCIvPgogIDx0ZXh0IHg9IjE1MCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIyMCI+VGVzdCBJbWFnZTwvdGV4dD4KPC9zdmc+" 
                 alt="Test Image"
                 class="test-image layers-thumbnail"
                 data-layer-data='{"layers":[{"id":"test1","type":"rectangle","x":50,"y":50,"width":100,"height":60,"fill":"rgba(255,0,0,0.5)","stroke":"red","strokeWidth":2,"visible":true},{"id":"test2","type":"text","x":200,"y":80,"text":"Hello Layers!","fill":"yellow","fontSize":16,"visible":true}]}'>
        </div>
    </div>

    <div class="test-container">
        <h2>Test 4: Editor Hook</h2>
        <div id="editor-test" class="status info">Testing editor hook...</div>
        <button onclick="testEditor()" style="padding: 8px 16px; margin: 10px 0;">Test Editor Initialization</button>
        <div id="editor-container" style="min-height: 200px; border: 1px solid #ccc; margin-top: 10px;"></div>
    </div>

    <script>
        // Test MediaWiki environment
        function testMediaWiki() {
            const status = document.getElementById('mw-test');
            if (typeof mw !== 'undefined') {
                status.textContent = '✅ PASS: MediaWiki (mw) object is available';
                status.className = 'status pass';
                return true;
            } else {
                status.textContent = '❌ FAIL: MediaWiki (mw) object not found';
                status.className = 'status fail';
                return false;
            }
        }

        // Test Layers module loading
        function testModules() {
            const status = document.getElementById('module-test');
            
            if (typeof mw === 'undefined') {
                status.textContent = '❌ FAIL: MediaWiki not available (required for modules)';
                status.className = 'status fail';
                return false;
            }

            let results = [];
            
            // Check if layers module is loaded
            if (typeof mw.layers !== 'undefined') {
                results.push('✅ mw.layers available');
            } else {
                results.push('❌ mw.layers not found');
            }

            // Check if LayersViewer is available
            if (typeof LayersViewer !== 'undefined') {
                results.push('✅ LayersViewer class available');
            } else {
                results.push('❌ LayersViewer class not found');
            }

            // Check if LayersEditor is available
            if (typeof LayersEditor !== 'undefined') {
                results.push('✅ LayersEditor class available');
            } else {
                results.push('❌ LayersEditor class not found');
            }

            const allPassed = results.every(r => r.startsWith('✅'));
            status.innerHTML = results.join('<br>');
            status.className = allPassed ? 'status pass' : 'status fail';
            
            return allPassed;
        }

        // Test LayersViewer functionality
        function testViewer() {
            const status = document.getElementById('viewer-test');
            
            if (typeof LayersViewer === 'undefined') {
                status.textContent = '❌ FAIL: LayersViewer class not available';
                status.className = 'status fail';
                return false;
            }

            try {
                // Initialize viewers (this should be automatic)
                if (typeof mw !== 'undefined' && mw.layers && mw.layers.initializeLayerViewers) {
                    mw.layers.initializeLayerViewers();
                    status.textContent = '✅ PASS: LayersViewer initialized successfully';
                    status.className = 'status pass';
                } else {
                    status.textContent = '⚠️ WARNING: mw.layers.initializeLayerViewers not found, trying manual init...';
                    status.className = 'status info';
                    
                    // Manual test
                    const img = document.querySelector('.layers-thumbnail');
                    if (img && img.getAttribute('data-layer-data')) {
                        const layerData = JSON.parse(img.getAttribute('data-layer-data'));
                        new LayersViewer({
                            container: img.parentNode,
                            imageElement: img,
                            layerData: layerData
                        });
                        status.textContent = '✅ PASS: Manual LayersViewer initialization successful';
                        status.className = 'status pass';
                    }
                }
                return true;
            } catch (error) {
                status.textContent = '❌ FAIL: LayersViewer error - ' + error.message;
                status.className = 'status fail';
                return false;
            }
        }

        // Test editor hook
        function testEditor() {
            const status = document.getElementById('editor-test');
            const container = document.getElementById('editor-container');
            
            if (typeof mw === 'undefined' || !mw.hook) {
                status.textContent = '❌ FAIL: MediaWiki hooks not available';
                status.className = 'status fail';
                return false;
            }

            try {
                // Fire the editor hook
                mw.hook('layers.editor.init').fire({
                    filename: 'Test.jpg',
                    imageUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzQ0ODhkZCIvPgogIDx0ZXh0IHg9IjE1MCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIyMCI+VGVzdCBJbWFnZTwvdGV4dD4KPC9zdmc+',
                    container: container
                });
                
                status.textContent = '✅ PASS: Editor hook fired successfully';
                status.className = 'status pass';
                return true;
            } catch (error) {
                status.textContent = '❌ FAIL: Editor hook error - ' + error.message;
                status.className = 'status fail';
                return false;
            }
        }

        // Run tests when page loads
        window.addEventListener('load', function() {
            setTimeout(function() {
                testMediaWiki();
                testModules();
                testViewer();
            }, 500); // Give modules time to load
        });

        // Auto-refresh tests every 2 seconds for the first 10 seconds
        let refreshCount = 0;
        const refreshInterval = setInterval(function() {
            if (refreshCount < 5) {
                testModules();
                testViewer();
                refreshCount++;
            } else {
                clearInterval(refreshInterval);
            }
        }, 2000);

        // Log module loading for debugging
        if (typeof mw !== 'undefined' && mw.loader) {
            mw.loader.using(['ext.layers'], function() {
                console.log('ext.layers module loaded successfully');
                testModules();
                testViewer();
            }, function(error) {
                console.error('Failed to load ext.layers module:', error);
            });
        }
    </script>
</body>
</html>
