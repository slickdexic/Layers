{{DISPLAYTITLE:Extension:Layers â€” Professional Image Annotation}}{{Extension
|name            = Layers
|status          = stable
|type1           = media
|type2           = interface
|type3           = api
|author          = [[User:Pvodrazka|Pvodrazka]]
|version         = 1.1.6
|update          = 2025-12-20
|download        = {{GithubDownload|slickdexic|Layers}}
|readme          = [https://github.com/slickdexic/Layers/blob/main/README.md README]
|changelog       = [https://github.com/slickdexic/Layers/blob/main/CHANGELOG.md CHANGELOG]
|license         = GPL-2.0-or-later
|tags            = <image editor><image markup><annotation><canvas><drawing><non-destructive>
|mediawiki       = >= 1.39
|php             = >= 8.1
|needs-updatephp = yes
|description     = A professional-grade, non-destructive image annotation system with 13 drawing tools, style presets, named layer sets, and full keyboard accessibility.
}}

[[File:ExtensionLayersEditor.png|thumb|600px|right|The Layers editor interface showing drawing tools and layer management.]]

'''Layers''' is a modern, non-destructive image annotation and editing tool for MediaWiki. It enables users to add captions, callouts, highlights, shapes, and freehand drawings to images '''without altering the original file'''.

All edits are stored as validated JSON and rendered client-side for precise positioning. The system fully integrates into MediaWiki's file pages and parser.

Click the {{key press|'''Edit Layers'''}} tab on any image's File: page to access the editor.

Inspired by industry standards like [[w:Figma|Figma]], [[w:Canva|Canva]], and [[w:Adobe Photoshop|Photoshop]], users familiar with these tools will feel right at home.

{{Note|For '''MediaWiki 1.39.x - 1.43.x''', use the [https://github.com/slickdexic/Layers/tree/REL1_39 REL1_39 branch].}}

== Why Layers? ==
{| class="wikitable" style="width: 100%;"
|-
! style="width: 33%;" | ðŸŽ¨ '''Professional Tools'''
! style="width: 33%;" | ðŸ”’ '''Non-Destructive'''
! style="width: 33%;" | â™¿ '''Accessible'''
|-
| 13 drawing tools, style presets, alignment & distribution â€” everything you need to annotate images like a pro.
| Original images are never modified. All annotations are stored separately and can be edited, versioned, or removed at any time.
| WCAG 2.1 compliant with full keyboard navigation, screen reader support, and high contrast focus indicators.
|}

== Key Features ==

=== New in v1.1.6: Key Object Alignment ===
Industry-standard alignment behavior matching Adobe Illustrator and Photoshop:
* When multiple layers are selected, the '''last selected layer''' becomes the "key object"
* Other layers align '''TO''' the key object, which stays fixed in place
* Key object is visually distinguished with an '''orange border''' (others have blue)
* Works for all alignment operations: left, center, right, top, middle, bottom

=== Core Features ===
* '''Professional Editor''': A responsive, single-panel canvas with 13 drawing tools
* '''Style Presets''': Save and reuse style configurations per tool type. Create custom presets from selected layers or use built-in defaults
* '''Alignment & Distribution''': Align layers left/center/right, top/middle/bottom. Distribute layers evenly horizontally or vertically
* '''Named Layer Sets''': Multiple annotation sets per image (e.g., "default", "anatomy-labels", "notes")
* '''Revision History''': Automatically tracks up to 50 revisions per layer set, integrated with MediaWiki permissions
* '''Import Images''': Add external images (logos, icons, photos) as new layers
* '''Export as PNG''': Download annotated images with optional background
* '''Accessibility-First''': Built with WCAG 2.1 compliance, featuring keyboard shortcuts, skip links, and ARIA landmarks
* '''Wikitext Integration''': Simple syntax to toggle layers on/off in standard image links
* '''TypeScript Support''': Full type definitions (<code>types/layers.d.ts</code>) for extension developers

== Drawing Tools ==
{| class="wikitable"
! Tool !! Shortcut !! Purpose !! Key Features
|-
| Pointer || {{key press|V}} || Select and manipulate objects || Multi-select, bounding box handles, resize, rotate
|-
| Zoom || {{key press|Z}} || Zoom and pan the canvas || Mouse wheel zoom, pan with drag
|-
| Text || {{key press|T}} || Add text labels || Font selection, size, color, stroke, shadow
|-
| Text Box || {{key press|X}} || Multi-line text in container || Word wrap, alignment, padding, corner radius
|-
| Pen || {{key press|P}} || Freehand drawing || Smooth paths, adjustable stroke
|-
| Rectangle || {{key press|R}} || Draw rectangles || Adjustable stroke and fill
|-
| Circle || {{key press|C}} || Draw circles || Radius-based drawing
|-
| Ellipse || {{key press|E}} || Draw ellipses || Independent X/Y radius control
|-
| Polygon || {{key press|G}} || Draw polygons || Configurable sides, rounded corners
|-
| Star || {{key press|S}} || Draw star shapes || Configurable points, radii, rounded corners
|-
| Arrow || {{key press|A}} || Annotation arrows || Configurable head types, sizes, and line styles
|-
| Line || {{key press|L}} || Straight lines || Stroke width and color options
|-
| Blur || {{key press|B}} || Apply blur effect || Create depth and focus effects
|}

== Text Box Tool ==
The Text Box tool ({{key press|X}}) combines a rectangle container with rich text capabilities:
* '''Multi-line text''' with automatic word wrapping
* '''Font options''': Arial, Roboto, Noto Sans, Times New Roman, Courier New
* '''Text formatting''': Bold and italic styles
* '''Alignment''': Horizontal (left/center/right) and vertical (top/middle/bottom)
* '''Container styling''': Corner radius, padding, stroke, fill with transparency
* '''Text effects''': Stroke outline and drop shadow with customizable blur/offset

Perfect for creating professional callouts, labels, and information boxes.

== Layer Management ==
* '''Visibility toggles''': Show/hide individual layers with a single click
* '''Lock/unlock''': Prevent accidental modifications to finalized layers
* '''Drag-and-drop reorder''': Intuitive layer stacking order control
* '''Duplicate layers''': Quick copy of existing layers with all properties
* '''Multi-selection''': Select multiple layers with {{key press|Ctrl}}+click or marquee selection ({{key press|M}})
* '''Per-set background settings''': Background visibility and opacity saved independently per named set
* '''Delete with confirmation''': Safe deletion with undo support

== Style Options ==
{| class="wikitable" style="width: 100%;"
|-
! Category !! Options
|-
| '''Stroke''' || Color picker, width (0-50px), opacity, dash patterns
|-
| '''Fill''' || Color picker with transparency, gradient support via blend modes
|-
| '''Shadow''' || Enable/disable, color, blur (0-50px), offset X/Y, spread
|-
| '''Text''' || Stroke outline, drop shadow, font family, font size (8-144px)
|-
| '''Blend Modes''' || Normal, multiply, screen, overlay, darken, lighten, and more
|-
| '''Opacity''' || Layer-level and stroke/fill-specific opacity (0-100%)
|}

== Alignment & Distribution ==
Professional layout tools for precise positioning:

'''Alignment''' (with Key Object support):
* Align left, center (horizontal), right
* Align top, middle (vertical), bottom
* Last selected layer becomes the "key object" â€” other layers align to it

'''Distribution''':
* Distribute horizontally â€” equal spacing between layer centers
* Distribute vertically â€” equal spacing between layer centers

== Usage ==
=== In Wikitext ===
To display layers on a page, use the {{para|layers}} parameter in your file link:
<syntaxhighlight lang="wikitext">
[[File:Example.jpg|layers=on]]              <!-- Default layer set -->
[[File:Example.jpg|layers=anatomy]]         <!-- Named set "anatomy" -->
[[File:Example.jpg|layers=none]]            <!-- Explicitly disable -->
</syntaxhighlight>

{{Note|On File: pages, layers are NOT auto-displayed. You must explicitly use <code>layers=on</code> or <code>layers=setname</code> in wikitext.}}

=== Keyboard Shortcuts ===
{| class="wikitable"
! Action !! Shortcut
|-
| Undo || {{key press|Ctrl|Z}}
|-
| Redo || {{key press|Ctrl|Y}} or {{key press|Ctrl|Shift|Z}}
|-
| Copy || {{key press|Ctrl|C}}
|-
| Paste || {{key press|Ctrl|V}}
|-
| Delete || {{key press|Delete}}
|-
| Toggle Background || {{key press|Shift|B}}
|-
| Marquee Select || {{key press|M}}
|-
| Show Keyboard Help || {{key press|Shift|?}}
|}

== Installation ==
=== Download ===
<syntaxhighlight lang="bash">
cd extensions/
git clone https://github.com/slickdexic/Layers.git
cd Layers
composer install
npm install
</syntaxhighlight>

=== Configuration ===
Add to your [[Manual:LocalSettings.php|LocalSettings.php]]:
<syntaxhighlight lang="php">
wfLoadExtension( 'Layers' );

// Permissions
$wgGroupPermissions['user']['editlayers'] = true;
$wgGroupPermissions['autoconfirmed']['createlayers'] = true;
$wgGroupPermissions['sysop']['managelayerlibrary'] = true;
</syntaxhighlight>

=== Database Update ===
Run the maintenance script:
<syntaxhighlight lang="bash">
php maintenance/run.php update.php
</syntaxhighlight>

== Configuration Parameters ==
{| class="wikitable"
! Parameter !! Type !! Default !! Description
|-
| <code>$wgLayersEnable</code> || boolean || <code>true</code> || Master switch to enable/disable extension.
|-
| <code>$wgLayersDebug</code> || boolean || <code>true</code> || Enable debug logging to 'Layers' channel.
|-
| <code>$wgLayersMaxBytes</code> || integer || <code>2097152</code> || Max JSON size per layer set (2 MB).
|-
| <code>$wgLayersMaxLayerCount</code> || integer || <code>100</code> || Max layers per set.
|-
| <code>$wgLayersMaxNamedSets</code> || integer || <code>15</code> || Max named sets per image.
|-
| <code>$wgLayersMaxRevisionsPerSet</code> || integer || <code>50</code> || Max revisions kept per named set.
|-
| <code>$wgLayersMaxImageBytes</code> || integer || <code>1048576</code> || Max size for imported image layers (1 MB).
|-
| <code>$wgLayersMaxImageSize</code> || integer || <code>4096</code> || Max image dimension (px) for editing.
|-
| <code>$wgLayersImageMagickTimeout</code> || integer || <code>30</code> || Timeout for ImageMagick operations (seconds).
|}

=== Rate Limiting ===
<syntaxhighlight lang="php">
$wgRateLimits['editlayers-save']['user'] = [ 30, 3600 ];   // 30 saves per hour
$wgRateLimits['editlayers-save']['newbie'] = [ 5, 3600 ]; // 5 saves per hour
</syntaxhighlight>

== Permissions ==
{| class="wikitable"
! Right !! Description !! Default Groups
|-
| <code>editlayers</code> || Edit existing layer sets || user
|-
| <code>createlayers</code> || Create new layer sets || autoconfirmed
|-
| <code>managelayerlibrary</code> || Manage layer library || sysop
|}

== Technical Details ==
=== Architecture ===
* '''Backend''': PHP 8.1+ with 4 custom API endpoints (<code>layersinfo</code>, <code>layerssave</code>, <code>layersdelete</code>, <code>layersrename</code>)
* '''Frontend''': HTML5 Canvas-based editor with 85 JS files (~44K lines), 76 ES6 classes
* '''Code Splitting''': Viewer module (~610 lines) + Shared module (~5K lines) loads separately from Editor (~38K lines)
* '''Modern JavaScript''': 100% ES6 classes, no legacy prototype patterns

=== Testing ===
* '''5,412 Jest tests''' with ~92% statement coverage
* '''106 test suites''' covering all major components
* '''PHPUnit integration tests''' for backend API validation
* '''Playwright E2E tests''' for end-to-end workflow testing

=== Security ===
* '''CSRF protection''': All write endpoints require valid tokens
* '''Property whitelisting''': 50+ explicitly allowed fields, unknown properties stripped
* '''Rate limiting''': Configurable limits via MediaWiki's <code>pingLimiter</code>
* '''Text sanitization''': HTML and dangerous protocols stripped from user input
* '''Color validation''': Strict validation prevents XSS via style properties

== Use Cases ==
{| class="wikitable" style="width: 100%;"
|-
! Use Case !! How Layers Helps
|-
| '''Educational Content''' || Annotate diagrams, label anatomy, highlight key concepts with callouts
|-
| '''Documentation''' || Add numbered steps, highlight UI elements, create before/after comparisons
|-
| '''Visual Effects''' || Apply blur effects, draw attention to specific areas, create depth-of-field
|-
| '''Maps & Geography''' || Add markers, routes, region highlights without modifying base maps
|-
| '''Product Images''' || Add feature callouts, size indicators, brand overlays
|-
| '''Scientific Imagery''' || Label specimens, mark measurement points, add scale indicators
|-
| '''Collaborative Review''' || Multiple named layer sets allow different annotators to work independently
|}

== Accessibility ==
Layers follows [[w:WCAG|WCAG 2.1]] guidelines:
* '''Skip Links''': Jump directly to toolbar, canvas, or layer panel (WCAG 2.4.1)
* '''ARIA Landmarks''': Semantic regions for screen reader navigation (WCAG 1.3.1)
* '''Keyboard Navigation''': Full keyboard support with discoverable shortcuts
* '''Focus Management''': Visible focus indicators throughout the interface
* '''Live Regions''': Status updates announced to assistive technologies

== Troubleshooting ==
* [https://github.com/slickdexic/Layers/blob/main/docs/layers-all-troubleshooting.md Troubleshooting Guide]
* [https://github.com/slickdexic/Layers/blob/main/docs/KNOWN_ISSUES.md Known Issues]

'''Windows Composer Conflict:''' Some Windows systems have a Python package named "composer" that shadows PHP Composer. Use <code>npm run test:php</code> as an alternative.

== Documentation ==
* [https://github.com/slickdexic/Layers/blob/main/docs/ARCHITECTURE.md Technical Architecture]
* [https://github.com/slickdexic/Layers/blob/main/docs/ACCESSIBILITY.md Accessibility Features]
* [https://github.com/slickdexic/Layers/blob/main/docs/DEVELOPER_ONBOARDING.md Developer Onboarding]
* [https://github.com/slickdexic/Layers/blob/main/docs/NAMED_LAYER_SETS.md Named Layer Sets]
* [https://github.com/slickdexic/Layers/blob/main/docs/WIKITEXT_USAGE.md Wikitext Syntax]
* [https://github.com/slickdexic/Layers/blob/main/docs/CSP_GUIDE.md Content Security Policy Guide]

== Version History ==
{| class="wikitable"
! Version !! Date !! Highlights
|-
| '''1.1.6''' || 2025-12-20 || Key object alignment (Adobe-style), text layer alignment fix, ColorControlFactory extraction
|-
| '''1.1.5''' || 2025-12-18 || Alignment & distribution tools, style presets system
|-
| '''1.1.3''' || 2025-12-18 || Text shadow rendering fix, LayerDataNormalizer extraction
|-
| '''1.1.0''' || 2025-12-10 || Text Box tool, named layer sets, import/export
|-
| '''1.0.0''' || 2025-11-01 || Initial stable release
|}

See [https://github.com/slickdexic/Layers/blob/main/CHANGELOG.md CHANGELOG.md] for complete version history.

== Support ==
* [https://github.com/slickdexic/Layers/issues Issue Tracker] â€” Report bugs or request features
* [https://github.com/slickdexic/Layers/blob/main/CONTRIBUTING.md Contributing Guide] â€” Help improve Layers
* [https://github.com/slickdexic/Layers/discussions Discussions] â€” Ask questions and share ideas

== See Also ==
* [[Extension:ImageAnnotator]] â€” Alternative annotation extension
* [[Extension:DrawioEditor]] â€” Diagram editor integration
* [[Manual:Image_administration]] â€” MediaWiki image handling

[[Category:Image extensions]]
[[Category:User interface extensions]]
[[Category:API extensions]]
[[Category:Stable extensions]]