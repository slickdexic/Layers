<!DOCTYPE html>
<html>
<head>
    <title>Background Image Loading Test</title>
    <style>
        body { margin: 20px; font-family: Arial, sans-serif; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .test-image { max-width: 200px; border: 1px solid #ddd; margin: 10px 0; }
        .results { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 15px; margin: 10px 0; }
        button { background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .debug { font-family: monospace; font-size: 12px; background: #000; color: #0f0; padding: 10px; border-radius: 4px; white-space: pre-line; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Background Image Loading Test</h1>
        
        <h3>Test Image (what should appear in editor):</h3>
        <img src="https://picsum.photos/400/300?random=100" alt="Test Image" class="test-image" id="testImage">
        
        <div>
            <button onclick="testDirectLoad()">Test Direct Image Load</button>
            <button onclick="testWithEditor()">Test With Editor</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
        
        <div class="results">
            <h4>Results:</h4>
            <div id="results">Click a test button to start...</div>
        </div>
        
        <div class="debug" id="debugOutput">Debug output will appear here...</div>
    </div>

    <script>
        function log(msg) {
            var debug = document.getElementById('debugOutput');
            var time = new Date().toLocaleTimeString();
            debug.textContent += time + ': ' + msg + '\n';
            debug.scrollTop = debug.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = 'Cleared...';
            document.getElementById('debugOutput').textContent = 'Debug cleared...\n';
        }

        function testDirectLoad() {
            log('=== Testing Direct Image Load ===');
            var testImg = document.getElementById('testImage');
            var testUrl = testImg.src;
            
            log('Test URL: ' + testUrl);
            
            var img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                log('SUCCESS: Image loaded - ' + img.width + 'x' + img.height);
                
                // Create a small canvas to test drawing
                var canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 150;
                canvas.style.border = '1px solid #000';
                
                var ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                var results = document.getElementById('results');
                results.innerHTML = '<strong>Direct Load: SUCCESS</strong><br>Image Size: ' + img.width + 'x' + img.height + '<br>';
                results.appendChild(canvas);
                
                log('Canvas test completed successfully');
            };
            
            img.onerror = function() {
                log('ERROR: Image failed to load');
                document.getElementById('results').innerHTML = '<strong>Direct Load: FAILED</strong><br>Could not load image from: ' + testUrl;
            };
            
            img.src = testUrl;
        }

        function testWithEditor() {
            log('=== Testing With Editor ===');
            
            // Simple mock for testing
            window.mw = {
                config: { get: (key) => ({ 'wgServer': location.protocol + '//' + location.host, 'wgScriptPath': '' }[key]) },
                hook: (name) => ({ add: (cb) => cb, fire: (data) => {} }),
                Api: () => ({ get: () => ({ done: (cb) => setTimeout(() => cb({layersinfo: {layerset: {data: {layers: []}}}}), 10), fail: () => ({}) }), post: () => ({ done: (cb) => setTimeout(() => cb({success: true}), 10), fail: () => ({}) }) }),
                notify: () => {}, msg: (key) => key
            };

            // Minimal jQuery mock
            if (!window.$) {
                window.$ = function(sel) {
                    if (typeof sel === 'function') return document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', sel) : sel();
                    var els = typeof sel === 'string' ? (sel.startsWith('<') ? [document.createElement(sel.match(/<(\w+)/)[1])] : Array.from(document.querySelectorAll(sel))) : [sel];
                    var jq = Object.assign(els, {
                        addClass: function(c) { this.forEach(el => el.classList.add(c)); return this; },
                        css: function(s) { this.forEach(el => Object.assign(el.style, s)); return this; },
                        attr: function(n, v) { if (v !== undefined) { this.forEach(el => el.setAttribute(n, v)); return this; } return this[0]?.getAttribute(n); },
                        appendTo: function(p) { var parent = typeof p === 'string' ? document.querySelector(p) : p; this.forEach(el => parent.appendChild(el)); return this; },
                        get: function(i) { return this[i]; }, remove: function() { this.forEach(el => el.remove()); return this; },
                        text: function(t) { if (t !== undefined) { this.forEach(el => el.textContent = t); return this; } return this[0]?.textContent; },
                        fadeOut: function() { this.forEach(el => { el.style.opacity = '0'; setTimeout(() => el.style.display = 'none', 300); }); return this; },
                        on: function(e, h) { this.forEach(el => el.addEventListener(e.split('.')[0], h)); return this; },
                        off: function() { return this; }
                    });
                    return jq;
                };
            }
            
            // Load the extension if not already loaded
            if (typeof window.LayersEditor === 'undefined') {
                log('Loading extension scripts...');
                
                var scripts = [
                    'resources/ext.layers.editor/CanvasManager.js',
                    'resources/ext.layers.editor/LayerPanel.js', 
                    'resources/ext.layers.editor/Toolbar.js',
                    'resources/ext.layers.editor/LayersEditor.js'
                ];
                
                var loadNext = function(index) {
                    if (index >= scripts.length) {
                        // All scripts loaded, now test
                        setTimeout(function() {
                            log('Scripts loaded, creating editor...');
                            createEditor();
                        }, 100);
                        return;
                    }
                    
                    var script = document.createElement('script');
                    script.src = scripts[index];
                    script.onload = function() {
                        log('Loaded: ' + scripts[index]);
                        loadNext(index + 1);
                    };
                    script.onerror = function() {
                        log('ERROR loading: ' + scripts[index]);
                    };
                    document.head.appendChild(script);
                };
                
                loadNext(0);
            } else {
                createEditor();
            }
        }

        function createEditor() {
            try {
                var testImg = document.getElementById('testImage');
                var config = {
                    filename: 'test-bg-load.jpg',
                    imageUrl: testImg.src
                };
                
                log('Creating editor with config: ' + JSON.stringify(config));
                
                var editor = new window.LayersEditor(config);
                
                // Monitor the background image loading
                setTimeout(function() {
                    if (editor.canvasManager) {
                        var bgImg = editor.canvasManager.backgroundImage;
                        if (bgImg && bgImg.complete) {
                            log('SUCCESS: Editor loaded background image - ' + bgImg.width + 'x' + bgImg.height);
                            document.getElementById('results').innerHTML = '<strong>Editor Test: SUCCESS</strong><br>Background loaded: ' + bgImg.width + 'x' + bgImg.height;
                        } else {
                            log('PROBLEM: Editor did not load background image properly');
                            log('Background image object: ' + (bgImg ? 'exists but not complete' : 'null'));
                            document.getElementById('results').innerHTML = '<strong>Editor Test: PARTIAL</strong><br>Editor created but background not loaded';
                        }
                    } else {
                        log('ERROR: Editor canvasManager not found');
                        document.getElementById('results').innerHTML = '<strong>Editor Test: FAILED</strong><br>CanvasManager not initialized';
                    }
                }, 2000);
                
            } catch (error) {
                log('ERROR: ' + error.message);
                document.getElementById('results').innerHTML = '<strong>Editor Test: FAILED</strong><br>Error: ' + error.message;
            }
        }

        // Start with a basic readiness check
        log('Page loaded, ready for testing');
        log('Available tests: Direct Load, Editor Load');
    </script>
</body>
</html>
