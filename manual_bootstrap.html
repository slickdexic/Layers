<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Manual Layers Editor Bootstrap Test</title>
    <style>
        body { margin: 20px; font-family: Arial, sans-serif; }
        .status { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        #editor-container { width: 100%; height: 500px; border: 1px solid #ccc; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Manual Layers Editor Bootstrap Test</h1>
    <button onclick="startTest()">Start Test</button>
    <div id="log"></div>
    <div id="editor-container"></div>

    <script>
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = 'status ' + type;
            div.textContent = new Date().toLocaleTimeString() + ': ' + msg;
            document.getElementById('log').appendChild(div);
        }

        // Simulate MediaWiki environment if not available
        if (!window.mw) {
            window.mw = {
                config: {
                    store: {
                        'wgLayersEditorInit': {
                            filename: 'ImageTest02.jpg',
                            imageUrl: '/images/8/8b/ImageTest02.jpg'
                        }
                    },
                    get: function(key) {
                        return this.store[key] || null;
                    },
                    set: function(key, value) {
                        this.store[key] = value;
                    }
                },
                message: function(key) {
                    return {
                        text: function() { return key; }
                    };
                },
                hook: function(name) {
                    if (!this.hooks) this.hooks = {};
                    if (!this.hooks[name]) this.hooks[name] = [];
                    return {
                        add: function(fn) {
                            mw.hooks[name].push(fn);
                        },
                        fire: function(data) {
                            mw.hooks[name].forEach(fn => fn(data));
                        }
                    };
                },
                hooks: {},
                Api: function() {
                    return {
                        get: function() {
                            return jQuery.Deferred().resolve({
                                layersinfo: { layerset: { data: { layers: [] } } }
                            });
                        },
                        postWithToken: function() {
                            return jQuery.Deferred().resolve({
                                layerssave: { success: true }
                            });
                        }
                    };
                },
                notify: function(msg, opts) {
                    log(msg, opts && opts.type || 'info');
                }
            };
        }

        // Load jQuery if not available
        if (!window.jQuery) {
            const script = document.createElement('script');
            script.src = 'https://code.jquery.com/jquery-3.6.0.min.js';
            script.onload = function() {
                window.$ = window.jQuery;
                log('jQuery loaded');
            };
            document.head.appendChild(script);
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function startTest() {
            try {
                log('Starting manual editor test...');

                // Wait for jQuery if it's still loading
                if (!window.jQuery) {
                    log('Waiting for jQuery...');
                    await new Promise(resolve => {
                        const check = () => {
                            if (window.jQuery) resolve();
                            else setTimeout(check, 100);
                        };
                        check();
                    });
                }

                log('Loading editor scripts...');
                
                // Load scripts in order
                await loadScript('/extensions/Layers/resources/ext.layers.editor/CanvasManager.js');
                log('CanvasManager loaded: ' + !!window.CanvasManager);
                
                await loadScript('/extensions/Layers/resources/ext.layers.editor/LayerPanel.js');
                log('LayerPanel loaded: ' + !!window.LayerPanel);
                
                await loadScript('/extensions/Layers/resources/ext.layers.editor/Toolbar.js');
                log('Toolbar loaded: ' + !!window.Toolbar);
                
                await loadScript('/extensions/Layers/resources/ext.layers.editor/LayersEditor.js');
                log('LayersEditor loaded: ' + !!window.LayersEditor);

                if (window.LayersEditor) {
                    log('Creating editor instance...', 'info');
                    const editor = new window.LayersEditor({
                        filename: 'ImageTest02.jpg',
                        imageUrl: '/images/8/8b/ImageTest02.jpg',
                        container: document.getElementById('editor-container')
                    });
                    log('Editor instance created successfully!', 'success');
                } else {
                    log('LayersEditor class not available', 'error');
                }

            } catch (error) {
                log('Error: ' + error.message, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
