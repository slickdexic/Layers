name: E2E Tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  # Smoke tests run without MediaWiki - quick sanity check
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install npm dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run Playwright smoke tests
        run: npx playwright test tests/e2e/smoke.spec.js tests/e2e/modules.spec.js --workers=1
        env:
          CI: true

      - name: Upload Playwright results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-smoke-results
          path: playwright-report/
          retention-days: 7
          if-no-files-found: ignore

  # Full E2E tests with MediaWiki container
  # These tests require a working MediaWiki instance with database
  editor:
    runs-on: ubuntu-latest
    # Track status separately from workflow pass/fail
    outputs:
      result: ${{ job.status }}
    services:
      mariadb:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: mediawiki
          MYSQL_USER: mediawiki
          MYSQL_PASSWORD: mediawiki
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mariadb-admin ping -h localhost -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, mysqli, pdo_mysql, gd, xml
          tools: composer

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache MediaWiki
        id: cache-mediawiki
        uses: actions/cache@v4
        with:
          path: ~/mediawiki
          key: mediawiki-1.44.3-${{ hashFiles('.github/workflows/e2e.yml') }}

      - name: Download MediaWiki
        if: steps.cache-mediawiki.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/mediawiki
          cd ~/mediawiki
          wget -q https://releases.wikimedia.org/mediawiki/1.44/mediawiki-1.44.3.tar.gz
          tar -xzf mediawiki-1.44.3.tar.gz --strip-components=1
          rm mediawiki-1.44.3.tar.gz

      - name: Install MediaWiki
        run: |
          cd ~/mediawiki
          # Always reinstall - the database is fresh on each run (services don't cache)
          # Remove old LocalSettings.php if it exists from cache
          rm -f LocalSettings.php
          php maintenance/install.php \
            --dbtype=mysql \
            --dbserver=127.0.0.1 \
            --dbname=mediawiki \
            --dbuser=mediawiki \
            --dbpass=mediawiki \
            --pass=LayersE2E_Test_2025 \
            --scriptpath="" \
            "Layers Test Wiki" \
            "Admin"

      - name: Install Layers extension
        run: |
          mkdir -p ~/mediawiki/extensions/Layers
          cp -r . ~/mediawiki/extensions/Layers/
          echo "wfLoadExtension( 'Layers' );" >> ~/mediawiki/LocalSettings.php
          echo "\$wgGroupPermissions['user']['editlayers'] = true;" >> ~/mediawiki/LocalSettings.php
          echo "\$wgGroupPermissions['user']['createlayers'] = true;" >> ~/mediawiki/LocalSettings.php
          # Allow anonymous access to editor for E2E tests (tests don't use loggedInPage fixture)
          echo "\$wgGroupPermissions['*']['editlayers'] = true;" >> ~/mediawiki/LocalSettings.php
          echo "\$wgGroupPermissions['*']['read'] = true;" >> ~/mediawiki/LocalSettings.php

      - name: Run MediaWiki database update
        run: |
          cd ~/mediawiki
          php maintenance/update.php --quick

      - name: Create and upload test image
        run: |
          cd ~/mediawiki
          # Create a simple test image
          php -r "
            \$img = imagecreatetruecolor(800, 600);
            \$bg = imagecolorallocate(\$img, 200, 200, 200);
            imagefill(\$img, 0, 0, \$bg);
            imagepng(\$img, 'test_image.png');
          "
          echo "Created test image:"
          ls -la test_image.png
          
          # Enable file uploads in LocalSettings.php
          echo "\$wgEnableUploads = true;" >> LocalSettings.php
          echo "\$wgFileExtensions[] = 'png';" >> LocalSettings.php
          
          # Import test image via maintenance script
          echo "Running importImages.php..."
          php maintenance/importImages.php --comment="Test image for E2E tests" --user=Admin --overwrite . 2>&1 | head -20

      - name: Start MediaWiki server
        run: |
          cd ~/mediawiki
          php -S 0.0.0.0:8080 &
          sleep 5
          # Verify server is running (accepts 200, 301, 302 redirects)
          curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ | grep -qE "200|301|302" || exit 1
        env:
          MW_SERVER: http://localhost:8080

      - name: Upload test image via API (fallback)
        run: |
          cd ~/mediawiki
          
          # Check if file already exists
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8080/index.php?title=File:Test_image.png")
          echo "File page HTTP code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -eq "200" ]; then
            echo "✓ File already exists from importImages.php"
          else
            echo "File not found, uploading via API..."
            
            # Get login token
            TOKEN=$(curl -s -c cookies.txt -b cookies.txt "http://localhost:8080/api.php?action=query&meta=tokens&type=login&format=json" | php -r 'echo json_decode(file_get_contents("php://stdin"))->query->tokens->logintoken;')
            
            # Login
            curl -s -c cookies.txt -b cookies.txt -X POST "http://localhost:8080/api.php" \
              -d "action=login&lgname=Admin&lgpassword=LayersE2E_Test_2025&lgtoken=$TOKEN&format=json" > /dev/null
            
            # Get CSRF token
            CSRF=$(curl -s -c cookies.txt -b cookies.txt "http://localhost:8080/api.php?action=query&meta=tokens&format=json" | php -r 'echo json_decode(file_get_contents("php://stdin"))->query->tokens->csrftoken;')
            
            # Upload file
            RESULT=$(curl -s -c cookies.txt -b cookies.txt -X POST "http://localhost:8080/api.php" \
              -F "action=upload" \
              -F "filename=Test_image.png" \
              -F "comment=Test image for E2E tests" \
              -F "file=@test_image.png" \
              -F "token=$CSRF" \
              -F "format=json")
            echo "$RESULT" | php -r 'print_r(json_decode(file_get_contents("php://stdin")));'
          fi

      - name: Verify test environment
        run: |
          # Check if the file page exists
          echo "Checking file page..."
          HTTP_CODE=$(curl -s -o /tmp/filepage.html -w "%{http_code}" "http://localhost:8080/index.php?title=File:Test_image.png")
          echo "File page HTTP code: $HTTP_CODE"
          
          # Check if the editlayers action works
          echo "Checking editlayers action..."
          HTTP_CODE=$(curl -s -o /tmp/editorpage.html -w "%{http_code}" "http://localhost:8080/index.php?title=File:Test_image.png&action=editlayers")
          echo "Editor page HTTP code: $HTTP_CODE"
          
          # Check if layers-canvas appears in the page
          if grep -q "layers-canvas" /tmp/editorpage.html; then
            echo "✓ layers-canvas found in page"
          else
            echo "✗ layers-canvas NOT found in page"
            echo "Page content (first 2000 chars):"
            head -c 2000 /tmp/editorpage.html
          fi

      - name: Install npm dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run Editor E2E tests
        run: npx playwright test tests/e2e/editor.spec.js --workers=1 --timeout=60000
        env:
          CI: true
          MW_SERVER: http://localhost:8080
          MW_USERNAME: Admin
          MW_PASSWORD: LayersE2E_Test_2025
          TEST_FILE: Test_image.png

      - name: Upload Playwright results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-editor-results
          path: playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

