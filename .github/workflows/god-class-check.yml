name: God Class Growth Prevention

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'resources/**/*.js'

jobs:
  check-god-classes:
    runs-on: ubuntu-latest
    name: Prevent God Class Growth
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for god class growth
        run: |
          echo "üîç Checking for god class growth..."
          echo ""
          
          # Define god classes and their baseline sizes (as of Dec 18, 2025)
          # These are the current line counts - PRs must not increase them
          declare -A GOD_CLASSES=(
            ["resources/ext.layers.editor/CanvasManager.js"]=1805    # Facade with 10+ controllers - acceptable
            ["resources/ext.layers.editor/LayerPanel.js"]=1720       # Facade with 7 controllers - acceptable
            ["resources/ext.layers.editor/APIManager.js"]=1168       # Has APIErrorHandler delegation
            ["resources/ext.layers.editor/LayersEditor.js"]=1301     # Partial delegation
            ["resources/ext.layers.editor/ToolManager.js"]=1275      # Has 2 tool handlers
            ["resources/ext.layers.editor/SelectionManager.js"]=1147 # Has 3 modules (SelectionState, MarqueeSelection, SelectionHandles)
            ["resources/ext.layers.editor/Toolbar.js"]=1115          # Partial delegation (ColorPickerDialog, ToolbarKeyboard, etc.)
            ["resources/ext.layers.shared/ShapeRenderer.js"]=1049    # Has ShadowRenderer delegation
          )
          
          WARN_THRESHOLD=800
          BLOCK_THRESHOLD=1000
          
          FAILED=0
          WARNINGS=""
          BLOCKS=""
          IMPROVEMENTS=""
          
          for file in "${!GOD_CLASSES[@]}"; do
            baseline=${GOD_CLASSES[$file]}
            
            if [ -f "$file" ]; then
              current=$(wc -l < "$file" | tr -d ' ')
              
              if [ "$current" -gt "$baseline" ]; then
                growth=$((current - baseline))
                BLOCKS+="‚ùå BLOCKED: $file grew from $baseline to $current lines (+$growth)\n"
                FAILED=1
              elif [ "$current" -lt "$baseline" ]; then
                reduction=$((baseline - current))
                IMPROVEMENTS+="‚úÖ IMPROVED: $file reduced from $baseline to $current lines (-$reduction)\n"
              else
                WARNINGS+="‚ûñ UNCHANGED: $file remains at $current lines\n"
              fi
            fi
          done
          
          # Check for NEW god classes (any file >1000 lines not in baseline)
          echo "üîç Checking for new god classes..."
          while IFS= read -r file; do
            lines=$(echo "$file" | awk '{print $1}')
            filepath=$(echo "$file" | awk '{print $2}')
            
            # Skip if it's already tracked
            is_tracked=0
            for known in "${!GOD_CLASSES[@]}"; do
              if [ "$known" == "$filepath" ]; then
                is_tracked=1
                break
              fi
            done
            
            if [ $is_tracked -eq 0 ] && [ "$lines" -gt "$BLOCK_THRESHOLD" ]; then
              BLOCKS+="‚ùå NEW GOD CLASS: $filepath has $lines lines (max $BLOCK_THRESHOLD for new files)\n"
              FAILED=1
            elif [ $is_tracked -eq 0 ] && [ "$lines" -gt "$WARN_THRESHOLD" ]; then
              WARNINGS+="‚ö†Ô∏è WARNING: $filepath has $lines lines (approaching $BLOCK_THRESHOLD limit)\n"
            fi
          done < <(find resources -name "*.js" -type f ! -path "*/dist/*" ! -path "*backup*" -exec wc -l {} \; | sort -rn)
          
          echo "=========================================="
          echo "GOD CLASS GROWTH PREVENTION REPORT"
          echo "=========================================="
          echo ""
          
          if [ -n "$BLOCKS" ]; then
            echo "üö´ BLOCKING ISSUES:"
            echo -e "$BLOCKS"
            echo ""
          fi
          
          if [ -n "$IMPROVEMENTS" ]; then
            echo "üéâ IMPROVEMENTS:"
            echo -e "$IMPROVEMENTS"
            echo ""
          fi
          
          if [ -n "$WARNINGS" ]; then
            echo "üìã STATUS:"
            echo -e "$WARNINGS"
          fi
          
          echo ""
          echo "=========================================="
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "‚ùå BUILD FAILED: God class growth detected!"
            echo ""
            echo "To fix this:"
            echo "1. Extract code from the growing file into a new, smaller module"
            echo "2. Or refactor to reduce the file size"
            echo "3. Do NOT increase god class sizes"
            echo ""
            echo "See: improvement_plan.md for refactoring guidance"
            echo "See: CRITICAL_REVIEW_2025-12-18.md for context"
            exit 1
          else
            echo ""
            echo "‚úÖ All god class checks passed!"
            echo ""
            echo "Tip: Help reduce technical debt by extracting code from god classes."
            echo "Current god classes: ${#GOD_CLASSES[@]} files (~11,500 lines total)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## God Class Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This check prevents god classes (files >1,000 lines) from growing." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current god classes (8 files, ~11,580 lines) - December 2025:**" >> $GITHUB_STEP_SUMMARY
          echo "- CanvasManager.js (1,805 lines) - ‚úÖ facade, delegates to 10+ controllers" >> $GITHUB_STEP_SUMMARY
          echo "- LayerPanel.js (1,720 lines) - ‚úÖ delegates to 7 controllers" >> $GITHUB_STEP_SUMMARY
          echo "- LayersEditor.js (1,301 lines) - partial delegation" >> $GITHUB_STEP_SUMMARY
          echo "- ToolManager.js (1,275 lines) - ‚úÖ delegates to 2 handlers" >> $GITHUB_STEP_SUMMARY
          echo "- APIManager.js (1,168 lines) - has APIErrorHandler delegation" >> $GITHUB_STEP_SUMMARY
          echo "- SelectionManager.js (1,147 lines) - ‚úÖ delegates to 3 modules" >> $GITHUB_STEP_SUMMARY
          echo "- Toolbar.js (1,115 lines) - partial delegation" >> $GITHUB_STEP_SUMMARY
          echo "- ShapeRenderer.js (1,049 lines) - has ShadowRenderer delegation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [improvement_plan.md](improvement_plan.md) for remediation roadmap." >> $GITHUB_STEP_SUMMARY
