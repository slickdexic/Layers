<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaWiki Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f6f6f6;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .test-image {
            max-width: 300px;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
        
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        button:hover {
            background: #005a87;
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
    
    <!-- Include the CSS -->
    <link rel="stylesheet" href="resources/ext.layers.editor/editor.css">
</head>
<body>
    <div class="test-container">
        <h1>MediaWiki Layers Extension Test</h1>
        <p>This test simulates exactly how MediaWiki would initialize the Layers editor.</p>
        
        <h3>Test Image:</h3>
        <img src="https://picsum.photos/600/400?random=2" alt="Test Image" class="test-image" id="testImage">
        
        <div>
            <button onclick="startEditor()">Start Layers Editor (MediaWiki Style)</button>
            <button onclick="clearDebug()">Clear Debug</button>
        </div>
        
        <div class="debug-info" id="debugInfo">
            Debug output will appear here...
        </div>
    </div>

    <!-- MediaWiki Mock Environment -->
    <script>
        // Enhanced MediaWiki mock
        window.mw = {
            config: {
                _values: {
                    'wgServer': window.location.protocol + '//' + window.location.host,
                    'wgScriptPath': '',
                    'wgArticlePath': '/wiki/$1',
                    'wgPageName': 'File:Test-image.jpg',
                    'wgTitle': 'Test-image.jpg',
                    'wgNamespaceNumber': 6  // File namespace
                },
                get: function(key) {
                    console.log('MW Config get:', key, '=', this._values[key]);
                    return this._values[key];
                }
            },
            hook: function(name) {
                console.log('MW Hook created:', name);
                return {
                    add: function(callback) {
                        if (!window._mwHooks) window._mwHooks = {};
                        if (!window._mwHooks[name]) window._mwHooks[name] = [];
                        window._mwHooks[name].push(callback);
                        console.log('MW Hook callback added for:', name);
                    },
                    fire: function(data) {
                        console.log('MW Hook fired:', name, data);
                        if (window._mwHooks && window._mwHooks[name]) {
                            window._mwHooks[name].forEach(callback => {
                                try {
                                    callback(data);
                                } catch (e) {
                                    console.error('Hook callback error:', e);
                                }
                            });
                        }
                    }
                };
            },
            Api: function() {
                console.log('MW API instance created');
                return {
                    get: function(params) {
                        console.log('MW API get called:', params);
                        return {
                            done: function(callback) {
                                setTimeout(() => {
                                    console.log('MW API get response sent');
                                    callback({
                                        layersinfo: {
                                            layerset: {
                                                data: {
                                                    layers: []
                                                }
                                            }
                                        }
                                    });
                                }, 100);
                                return this;
                            },
                            fail: function(callback) {
                                return this;
                            }
                        };
                    },
                    post: function(params) {
                        console.log('MW API post called:', params);
                        return {
                            done: function(callback) {
                                setTimeout(() => {
                                    console.log('MW API post response sent');
                                    callback({success: true});
                                }, 100);
                                return this;
                            },
                            fail: function(callback) {
                                return this;
                            }
                        };
                    }
                };
            },
            notify: function(message, options) {
                console.log('MW Notification:', message, options);
                debugLog('MW Notification: ' + message);
            },
            msg: function(key) {
                var messages = {
                    'layers-save-success': 'Layers saved successfully',
                    'layers-save-error': 'Failed to save layers'
                };
                return messages[key] || key;
            }
        };

        // Enhanced jQuery mock that's more compatible
        window.jQuery = window.$ = function(selector) {
            var elements = [];
            
            if (typeof selector === 'function') {
                // Document ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', selector);
                } else {
                    setTimeout(selector, 0);
                }
                return;
            }
            
            if (typeof selector === 'string') {
                if (selector.startsWith('<')) {
                    // Create element
                    var match = selector.match(/<(\w+)/);
                    if (match) {
                        var element = document.createElement(match[1]);
                        elements = [element];
                    }
                } else {
                    // Query selector
                    elements = Array.from(document.querySelectorAll(selector));
                }
            } else if (selector && selector.nodeType) {
                // DOM element
                elements = [selector];
            } else if (Array.isArray(selector)) {
                elements = selector;
            }
            
            // Create jQuery-like object
            var jq = Object.create(Array.prototype);
            jq.push.apply(jq, elements);
            
            // Add jQuery methods
            jq.addClass = function(className) {
                this.forEach(el => el.classList.add(className));
                return this;
            };
            
            jq.removeClass = function(className) {
                this.forEach(el => el.classList.remove(className));
                return this;
            };
            
            jq.css = function(styles) {
                this.forEach(el => {
                    if (typeof styles === 'object') {
                        Object.assign(el.style, styles);
                    }
                });
                return this;
            };
            
            jq.attr = function(name, value) {
                if (value !== undefined) {
                    this.forEach(el => el.setAttribute(name, value));
                    return this;
                }
                return this[0] ? this[0].getAttribute(name) : null;
            };
            
            jq.appendTo = function(target) {
                var parent = typeof target === 'string' ? 
                    document.querySelector(target) : target;
                if (parent && parent.appendChild) {
                    this.forEach(el => parent.appendChild(el));
                }
                return this;
            };
            
            jq.append = function(child) {
                // Handle different child types
                var childElement;
                if (typeof child === 'string') {
                    if (child.startsWith('<')) {
                        var temp = document.createElement('div');
                        temp.innerHTML = child;
                        childElement = temp.firstChild;
                    } else {
                        childElement = document.createTextNode(child);
                    }
                } else {
                    childElement = child;
                }
                
                this.forEach(el => {
                    if (el.appendChild) {
                        el.appendChild(childElement.cloneNode ? childElement.cloneNode(true) : childElement);
                    }
                });
                return this;
            };
            
            jq.text = function(text) {
                if (text !== undefined) {
                    this.forEach(el => el.textContent = text);
                    return this;
                }
                return this[0] ? this[0].textContent : '';
            };
            
            jq.fadeOut = function() {
                this.forEach(el => {
                    el.style.transition = 'opacity 0.3s';
                    el.style.opacity = '0';
                    setTimeout(() => el.style.display = 'none', 300);
                });
                return this;
            };
            
            jq.remove = function() {
                this.forEach(el => el.remove());
                return this;
            };
            
            jq.on = function(event, handler) {
                this.forEach(el => {
                    var eventName = event.split('.')[0];
                    el.addEventListener(eventName, handler);
                });
                return this;
            };
            
            jq.off = function(event) {
                // Simplified for testing
                return this;
            };
            
            jq.get = function(index) {
                return index !== undefined ? this[index] : this.slice();
            };
            
            jq.first = function() {
                return $(this[0] ? [this[0]] : []);
            };
            
            return jq;
        };
        
        // Debug logging
        function debugLog(message) {
            var debugInfo = document.getElementById('debugInfo');
            debugInfo.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        function clearDebug() {
            document.getElementById('debugInfo').textContent = 'Debug cleared...\n';
        }

        // Override console.log to capture in debug
        var originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            debugLog(args.join(' '));
        };
        
        var originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            debugLog('ERROR: ' + args.join(' '));
        };
    </script>

    <!-- Load Extension Components -->
    <script src="resources/ext.layers.editor/CanvasManager.js"></script>
    <script src="resources/ext.layers.editor/LayerPanel.js"></script>
    <script src="resources/ext.layers.editor/Toolbar.js"></script>
    <script src="resources/ext.layers.editor/LayersEditor.js"></script>

    <script>
        function startEditor() {
            debugLog('=== Starting MediaWiki-style editor initialization ===');
            
            try {
                // Get the test image URL like MediaWiki would
                var testImage = document.getElementById('testImage');
                var filename = 'Test-image.jpg';
                
                debugLog('Image filename: ' + filename);
                debugLog('Image URL: ' + testImage.src);
                
                // Create the config exactly like MediaWiki extension would
                var config = {
                    filename: filename,
                    imageUrl: testImage.src
                };
                
                debugLog('Editor config: ' + JSON.stringify(config));
                
                // This is how MediaWiki would trigger the editor
                mw.hook('layers.editor.init').fire(config);
                
                debugLog('Hook fired, waiting for editor initialization...');
                
            } catch (error) {
                console.error('Failed to start editor:', error);
                debugLog('FAILED: ' + error.message);
            }
        }
        
        // Simulate page load
        window.addEventListener('load', function() {
            debugLog('Page loaded');
            debugLog('Components available:');
            debugLog('- LayersEditor: ' + (typeof window.LayersEditor !== 'undefined'));
            debugLog('- CanvasManager: ' + (typeof window.CanvasManager !== 'undefined'));
            debugLog('- LayerPanel: ' + (typeof window.LayerPanel !== 'undefined'));
            debugLog('- Toolbar: ' + (typeof window.Toolbar !== 'undefined'));
            debugLog('- MediaWiki mock: ' + (typeof window.mw !== 'undefined'));
            debugLog('- jQuery mock: ' + (typeof window.$ !== 'undefined'));
        });
    </script>
</body>
</html>
