mw.layers={init:function(){var e=this,a=!1;try{a=!("undefined"==typeof mw||!mw.config||!mw.config.get("wgLayersDebug"))}catch(e){}e.initializeLayerViewers(a),e.initializeFilePageFallback(a);try{mw&&mw.hook&&"function"==typeof mw.hook&&mw.hook("wikipage.content").add(function(){e.initializeLayerViewers(a),e.initializeFilePageFallback(a)})}catch(e){}},decodeHtmlEntities:function(e){return e&&"string"==typeof e?e.replace(/&amp;quot;/g,'"').replace(/&quot;/g,'"').replace(/&#34;/g,'"').replace(/&#x22;/gi,'"'):e},initializeLayerViewers:function(e){var a=this,t=Array.prototype.slice.call(document.querySelectorAll("img[data-layer-data]"));t.forEach(function(e){var a=e.getAttribute("class")||"";-1===a.indexOf("layers-thumbnail")&&e.setAttribute("class",(a+" layers-thumbnail").trim())}),e&&console.debug("[Layers] Found",t.length,"candidate <img> elements with data-layer-data"),Array.prototype.slice.call(document.querySelectorAll("a[data-layer-data] > img")).forEach(function(a){if(!a.hasAttribute("data-layer-data")){var i=a.parentNode&&1===a.parentNode.nodeType?a.parentNode:null;if(i&&i.hasAttribute("data-layer-data")){a.setAttribute("data-layer-data",i.getAttribute("data-layer-data"));var r=a.getAttribute("class")||"";-1===r.indexOf("layers-thumbnail")&&a.setAttribute("class",(r+" layers-thumbnail").trim()),t.push(a),e&&console.debug("[Layers] Moved data-layer-data from <a> to <img>")}}}),t.forEach(function(t){if(!t.layersViewer)try{var i,r=t.getAttribute("data-layer-data");if(!r)return;try{i=JSON.parse(r)}catch(t){var n=a.decodeHtmlEntities(r);e&&console.debug("[Layers] JSON parse failed, retrying after entity decode",t),i=JSON.parse(n)}if(!i||!i.layers)return void(e&&console.debug("[Layers] No usable layerData on element",t));var l=t.parentNode||t,o=window.getComputedStyle(l);if(!o||"static"===o.position){var s=document.createElement("span");s.style.position="relative",s.style.display="inline-block",l.insertBefore(s,t),s.appendChild(t),l=s}if(t.layersViewer=new window.LayersViewer({container:l,imageElement:t,layerData:i}),e){var d=i.layers&&i.layers.length||0;console.debug("[Layers] Viewer initialized with",d,"layers. baseWidth=",i.baseWidth,"baseHeight=",i.baseHeight)}}catch(a){e&&console.warn("[Layers] Viewer init error:",a)}})},initializeFilePageFallback:function(e){try{if("undefined"==typeof mw)return;if(6!==mw.config.get("wgNamespaceNumber"))return;var a=window.location.href||"";if(!/[?&#]layers=([^&#]+)/i.test(a))return void(e&&console.debug("[Layers] Skipping file page fallback: no layers= in URL"));var t=document.querySelector("#file img, .fullMedia a > img, .mw-filepage-content img");if(!t||t.layersViewer)return;if(t.getAttribute("data-layer-data"))return;var i,r=mw.config.get("wgPageName")||"",n=(mw.config.get("wgCanonicalNamespace")||"File")+":";i=0===r.indexOf(n)?r.slice(n.length):r;try{i=decodeURIComponent(i)}catch(e){}i=i.replace(/_/g," "),(new mw.Api).get({action:"layersinfo",format:"json",filename:i}).done(function(a){try{if(!a||!a.layersinfo||!a.layersinfo.layerset)return;var i=a.layersinfo.layerset,r=null;if(i&&i.data&&(i.data.layers||i.data)){var n,l=Object.prototype.toString.call(i.data.layers);(n=i.data.layers&&"[object Array]"===l?i.data.layers:i.data)&&n.length&&(r={layers:n,baseWidth:t.naturalWidth||t.width||null,baseHeight:t.naturalHeight||t.height||null})}if(!r)return;var o=t.parentNode||t,s=window.getComputedStyle(o);if(!s||"static"===s.position){var d=document.createElement("span");d.style.position="relative",d.style.display="inline-block",o.insertBefore(d,t),d.appendChild(t),o=d}if(t.layersViewer=new window.LayersViewer({container:o,imageElement:t,layerData:r}),e){var c=r.layers&&r.layers.length||0;console.debug("[Layers] File page fallback initialized with",c,"layers")}}catch(a){e&&console.warn("[Layers] File page fallback error:",a)}}).fail(function(){})}catch(a){e&&console.warn("[Layers] File page fallback outer error:",a)}}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){mw.layers.init()}):mw.layers.init(),window["Layersext.layers"]={};