(()=>{function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}!function(){"use strict";function t(e){this.config=e||{},this.filename=this.config.filename,this.containerElement=this.config.container,this.canvasManager=null,this.layerPanel=null,this.toolbar=null,this.layers=[],this.allLayerSets=[],this.currentLayerSetId=null,this.currentTool="pointer",this.isDirty=!1,this.debug=this.config.debug||!1,this.init()}t.prototype.debugLog=function(){if(this.debug){var e=Array.prototype.slice.call(arguments).map(function(e){return t.prototype.sanitizeLogMessage(e)});mw.log&&mw.log.apply(mw,e)}},t.prototype.errorLog=function(){var e=Array.prototype.slice.call(arguments).map(function(e){return t.prototype.sanitizeLogMessage(e)});mw.log&&mw.log.error.apply(mw.log,e)},t.prototype.sanitizeLogMessage=function(t){if("string"!=typeof t){if("object"===e(t)&&null!==t){var a=["type","action","status","tool","layer","count","x","y","width","height"],r={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(-1!==a.indexOf(s)?r[s]=t[s]:r[s]="[FILTERED]");return r}return t}var n=String(t);return(n=(n=(n=(n=(n=(n=(n=(n=n.replace(/[a-zA-Z0-9+/=]{20,}/g,"[TOKEN]")).replace(/[a-fA-F0-9]{16,}/g,"[HEX]")).replace(/[A-Za-z]:[\\/]][\w\s\\.-]*/g,"[PATH]")).replace(/\/[\w\s.-]+/g,"[PATH]")).replace(/https?:\/\/[^\s'"<>&]*/gi,"[URL]")).replace(/\w+:\/\/[^\s'"<>&]*/gi,"[CONNECTION]")).replace(/\b(?:\d{1,3}\.){3}\d{1,3}(?::\d+)?\b/g,"[IP]")).replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,"[EMAIL]")).length>200&&(n=n.slice(0,200)+"[TRUNCATED]"),n},t.prototype.init=function(){document.title="ðŸ”„ Layers Editor Loading...",this.checkBrowserCompatibility()?(this.createInterface(),this.undoStack=[],this.redoStack=[],this.maxUndoSteps=50,this.waitForDependencies()):this.showBrowserCompatibilityWarning()},t.prototype.checkBrowserCompatibility=function(){var e=["HTMLCanvasElement"in window,"JSON"in window,"addEventListener"in document,"querySelector"in document,"FileReader"in window,"Blob"in window];if(window.HTMLCanvasElement)try{var t=document.createElement("canvas").getContext("2d");e.push(!!t)}catch(t){e.push(!1)}return e.every(function(e){return!0===e})},t.prototype.showBrowserCompatibilityWarning=function(){var e=mw.message?mw.message("layers-browser-compatibility").text():"Your browser may not support all layer features";window.mw&&window.mw.notify?mw.notify(e,{type:"warn",autoHide:!1}):alert(e),this.createBasicInterface()},t.prototype.createBasicInterface=function(){this.container=document.createElement("div"),this.container.className="layers-editor layers-editor-basic";var e=document.createElement("div");e.className="layers-unsupported";var t=document.createElement("h3");t.textContent="Browser Not Fully Supported",e.appendChild(t);var a=document.createElement("p");a.textContent="The Layers editor requires a modern browser with Canvas support.",e.appendChild(a);var r=document.createElement("p");r.textContent="Please consider upgrading your browser for the full experience.",e.appendChild(r);var s=document.createElement("button");s.type="button",s.textContent="Close",s.addEventListener("click",function(){e&&e.parentNode&&(e.parentNode.style.display="none")}),e.appendChild(s),this.container.appendChild(e),document.body.appendChild(this.container)},t.prototype.waitForDependencies=function(){var e=this,t=0;!function a(){if(t++,window.mw&&window.mw.log&&(mw.log("Layers: Dependency check attempt "+t),mw.log("Layers: CanvasManager available:",!!window.CanvasManager),mw.log("Layers: LayerPanel available:",!!window.LayerPanel),mw.log("Layers: Toolbar available:",!!window.Toolbar)),window.CanvasManager&&window.LayerPanel&&window.Toolbar)window.mw&&window.mw.log&&mw.log("Layers: All dependencies loaded, initializing components"),e.initializeComponents();else if(t<50)setTimeout(a,100);else{var r=[];window.CanvasManager||r.push("CanvasManager"),window.LayerPanel||r.push("LayerPanel"),window.Toolbar||r.push("Toolbar"),window.mw&&window.mw.log&&mw.log.error("Layers: Missing dependencies after 5 seconds: "+r.join(", ")),e.showError((mw.message?mw.message("layers-error-init").text():"Failed to initialize Layers editor")+" ("+r.join(", ")+")")}}()},t.prototype.initializeComponents=function(){try{if(window.mw&&window.mw.log&&(mw.log("Layers: Initializing components..."),mw.log("Layers: Canvas container:",this.$canvasContainer.get(0)),mw.log("Layers: Layer panel container:",this.$layerPanel.get(0)),mw.log("Layers: Toolbar container:",this.$toolbar.get(0))),!window.CanvasManager)throw new Error("CanvasManager not available");if(!window.LayerPanel)throw new Error("LayerPanel not available");if(!window.Toolbar)throw new Error("Toolbar not available");var e=this.getParentImageUrl();window.mw&&window.mw.log&&mw.log("Layers: Parent image URL:",e),this.canvasManager=new window.CanvasManager({container:this.$canvasContainer.get(0),editor:this,backgroundImageUrl:e}),this.layerPanel=new window.LayerPanel({container:this.$layerPanel.get(0),editor:this,inspectorContainer:this.inspectorContainer}),this.toolbar=new window.Toolbar({container:this.$toolbar.get(0),editor:this}),window.mw&&window.mw.log&&(mw.log("Layers: Editor components initialized successfully"),mw.log("Layers: CanvasManager:",this.canvasManager),mw.log("Layers: LayerPanel:",this.layerPanel),mw.log("Layers: Toolbar:",this.toolbar))}catch(e){return window.mw&&window.mw.log&&mw.log.error("Layers: Error initializing editor components:",e),void this.showError("Failed to initialize editor: "+e.message)}this.loadLayers(),this.setupEventHandlers(),"function"==typeof this.updateStatus&&this.updateStatus({tool:this.currentTool||"pointer",zoomPercent:100,pos:{x:0,y:0},selectionCount:0}),window.mw&&window.mw.log&&mw.log("Layers: Editor fully initialized for file:",this.filename)},t.prototype.createInterface=function(){this.container=document.createElement("div"),this.container.className="layers-editor",this.container.setAttribute("role","application"),this.container.setAttribute("aria-label","Layers Image Editor"),document.body.appendChild(this.container),document.body.classList.add("layers-editor-open");var e=document.createElement("div");e.className="layers-header",e.setAttribute("role","banner");var t=document.createElement("div");t.className="layers-header-title",t.setAttribute("role","heading"),t.setAttribute("aria-level","1"),t.textContent=(mw.message?mw.message("layers-editor-title").text():mw.msg?mw.msg("layers-editor-title"):"Layers Editor")+(this.filename?" â€” "+this.filename:""),e.appendChild(t);var a=document.createElement("div");a.className="layers-header-right";var r=document.createElement("span");r.className="layers-zoom-readout",r.setAttribute("aria-label","Current zoom level"),r.textContent="100%",a.appendChild(r);var s=document.createElement("div");s.className="layers-revision-wrap";var n=document.createElement("label");n.className="layers-revision-label",n.textContent=(mw.message?mw.message("layers-revision-label").text():"Revision")+":",s.appendChild(n);var i=document.createElement("select");i.className="layers-revision-select",i.setAttribute("aria-label","Select revision to load"),n.setAttribute("for","layers-revision-select-"+Math.random().toString(36).slice(2,11)),i.id=n.getAttribute("for"),s.appendChild(i);var o=document.createElement("input");o.type="text",o.className="layers-revision-name",o.placeholder=mw.message?mw.message("layers-revision-name-placeholder").text():"Revision name (optional)",o.setAttribute("aria-label","Revision name for next save (optional)"),o.maxLength=255,s.appendChild(o);var l=document.createElement("button");l.type="button",l.className="layers-revision-load",l.textContent=mw.message?mw.message("layers-revision-load").text():"Load",l.setAttribute("aria-label","Load selected revision"),s.appendChild(l),a.appendChild(s);var d=document.createElement("button");d.className="layers-header-close",d.type="button",d.setAttribute("aria-label",mw.message?mw.message("layers-editor-close").text():"Close"),d.title=mw.message?mw.message("layers-editor-close").text():"Close",d.innerHTML="&times;",a.appendChild(d),e.appendChild(a),this.container.appendChild(e),this.toolbarContainer=document.createElement("div"),this.toolbarContainer.className="layers-toolbar",this.container.appendChild(this.toolbarContainer),this.content=document.createElement("div"),this.content.className="layers-content",this.container.appendChild(this.content);var c=document.createElement("div");c.className="layers-main",this.content.appendChild(c),this.layerPanelContainer=document.createElement("div"),this.layerPanelContainer.className="layers-panel",c.appendChild(this.layerPanelContainer),this.canvasContainer=document.createElement("div"),this.canvasContainer.className="layers-canvas-container",c.appendChild(this.canvasContainer),this.statusBar=document.createElement("div"),this.statusBar.className="layers-statusbar",this.statusBar.innerHTML='<span class="status-item"><span class="status-label">'+(mw.message?mw.message("layers-status-tool").text():"Tool")+':</span> <span class="status-value" data-status="tool">pointer</span></span><span class="status-item"><span class="status-label">'+(mw.message?mw.message("layers-status-zoom").text():"Zoom")+':</span> <span class="status-value" data-status="zoom">100%</span></span><span class="status-item"><span class="status-label">'+(mw.message?mw.message("layers-status-pos").text():"Pos")+':</span> <span class="status-value" data-status="pos">0,0</span></span><span class="status-item"><span class="status-label">'+(mw.message?mw.message("layers-status-size").text():"Size")+':</span> <span class="status-value" data-status="size">-</span></span><span class="status-item"><span class="status-label">'+(mw.message?mw.message("layers-status-selection").text():"Selection")+':</span> <span class="status-value" data-status="selection">0</span></span><span class="status-spacer"></span><span class="status-code" aria-label="'+(mw.message?mw.message("layers-code-title").text():"Wikitext Code")+'"><code class="status-code-text" title="'+(mw.message?mw.message("layers-code-title").text():"Wikitext Code")+'"></code><button class="status-copy-btn" type="button">'+(mw.message?mw.message("layers-code-copy").text():"Copy")+"</button></span>",this.container.appendChild(this.statusBar),this.$canvasContainer=$(this.canvasContainer),this.$layerPanel=$(this.layerPanelContainer),this.$toolbar=$(this.toolbarContainer);var y=this;Object.defineProperty(this,"zoomReadoutEl",{value:r}),this.updateZoomReadout=function(e){y.zoomReadoutEl.textContent=e+"%"},Object.defineProperty(this,"revSelectEl",{value:i}),Object.defineProperty(this,"revLoadBtnEl",{value:l}),Object.defineProperty(this,"revNameInputEl",{value:o}),l.addEventListener("click",function(){var e=0;y.revSelectEl&&y.revSelectEl.value&&(e=parseInt(y.revSelectEl.value,10)),e&&y.loadRevisionById(e)}),i.addEventListener("change",function(){var e=parseInt(this.value,10)||0;if(y.revLoadBtnEl){var t=y.currentLayerSetId&&e===y.currentLayerSetId;y.revLoadBtnEl.disabled=!e||t}}),this.updateStatus=function(e){if(e){var t=y.statusBar;if(t){if(null!==e.tool&&void 0!==e.tool){var a=t.querySelector('[data-status="tool"]');a&&(a.textContent=String(e.tool))}if(null!==e.zoomPercent&&void 0!==e.zoomPercent){var r=t.querySelector('[data-status="zoom"]');r&&(r.textContent=Math.round(e.zoomPercent)+"%")}if(null!==e.pos&&void 0!==e.pos&&"number"==typeof e.pos.x&&"number"==typeof e.pos.y){var s=t.querySelector('[data-status="pos"]');s&&(s.textContent=Math.round(e.pos.x)+","+Math.round(e.pos.y))}if(null!==e.size&&void 0!==e.size&&"number"==typeof e.size.width&&"number"==typeof e.size.height){var n=t.querySelector('[data-status="size"]');n&&(n.textContent=Math.round(e.size.width)+"Ã—"+Math.round(e.size.height))}if(null!==e.selectionCount&&void 0!==e.selectionCount){var i=t.querySelector('[data-status="selection"]');i&&(i.textContent=String(e.selectionCount))}}}},d.addEventListener("click",function(){y.cancel(!0)})},t.prototype.setupEventHandlers=function(){var e=this;this.onResizeHandler=function(){e.handleResize()},this.onBeforeUnloadHandler=function(t){e.isDirty&&(t.preventDefault(),t.returnValue="")},window.addEventListener("resize",this.onResizeHandler),window.addEventListener("beforeunload",this.onBeforeUnloadHandler)},t.prototype.loadLayers=function(){var t=this;this.debug&&this.debugLog("loadLayers called for filename:",this.filename),t.showSpinner(mw.message?mw.message("layers-loading").text():"Loading...");var a=new mw.Api;this.debug&&this.debugLog("Making API call to layersinfo for filename:",this.filename),a.get({action:"layersinfo",filename:this.filename,format:"json"}).done(function(a){if(t.debug&&t.debugLog("API call successful, received data:",a),t.hideSpinner(),t.debug&&(t.debugLog("Raw layersinfo API response:",a),a.layersinfo&&a.layersinfo.layerset&&(t.debugLog("Raw layerset data:",a.layersinfo.layerset),a.layersinfo.layerset.data&&a.layersinfo.layerset.data.layers&&(t.debugLog("Raw layers array:",a.layersinfo.layerset.data.layers),a.layersinfo.layerset.data.layers.forEach(function(e,a){t.debugLog("Raw Layer "+a+":",JSON.stringify(e,null,2))})))),a.layersinfo&&a.layersinfo.layerset){t.debug&&(t.debugLog("Found layerset data, processing layers..."),t.debugLog("Raw layerset data:",a.layersinfo.layerset));var r=a.layersinfo.layerset.data.layers||[];t.debug&&(t.debugLog("Raw layers array length:",r.length),t.debugLog("Raw layers array:",r)),t.layers=r.map(function(e){return e.id||(e.id="layer_"+Date.now()+"_"+Math.random().toString(36).slice(2,9)),["shadow","textShadow","glow","visible","locked"].forEach(function(t){"0"===e[t]||"false"===e[t]?e[t]=!1:""!==e[t]&&"1"!==e[t]&&"true"!==e[t]||(e[t]=!0)}),e}),t.currentLayerSetId=a.layersinfo.layerset.id||null,t.debug&&(t.debugLog("Processed layers count:",t.layers.length),t.debugLog("Processed layers array:",t.layers)),t.debug&&(t.debugLog("Loaded layers count:",t.layers.length),t.layers.forEach(function(a,r){t.debugLog("Loaded Layer "+r+":",a),t.debugLog("  Shadow after normalization:",{shadow:a.shadow,shadowType:e(a.shadow),shadowColor:a.shadowColor,shadowBlur:a.shadowBlur,shadowOffsetX:a.shadowOffsetX,shadowOffsetY:a.shadowOffsetY})}))}else t.debug&&t.debugLog("No layerset data found in API response"),t.layers=[];t.debug&&t.debugLog("Final layers array length before renderLayers:",t.layers.length),a.layersinfo&&Array.isArray(a.layersinfo.all_layersets)&&(t.allLayerSets=a.layersinfo.all_layersets.slice(),t.buildRevisionSelector()),t.renderLayers(),t.saveState("initial")}).fail(function(e,a){t.debug&&t.debugLog("API call failed with code:",e,"result:",a),t.hideSpinner(),t.layers=[],t.renderLayers(),t.saveState("initial");var r=mw.message?mw.message("layers-load-error").text():"Failed to load layers";a&&a.error&&a.error.info&&(r=a.error.info),mw.notify(r,{type:"error"})})},t.prototype.showSpinner=function(e){this.spinnerEl&&this.spinnerEl.remove(),this.spinnerEl=document.createElement("div"),this.spinnerEl.className="layers-spinner",this.spinnerEl.setAttribute("role","status"),this.spinnerEl.setAttribute("aria-live","polite");var t=document.createElement("span");t.className="spinner";var a=document.createElement("span");a.className="spinner-text",a.textContent=" "+(e||""),this.spinnerEl.appendChild(t),this.spinnerEl.appendChild(a),this.container.appendChild(this.spinnerEl)},t.prototype.hideSpinner=function(){this.spinnerEl&&(this.spinnerEl.remove(),this.spinnerEl=null)},t.prototype.buildRevisionSelector=function(){var e=this.revSelectEl;if(e){e.innerHTML="";var t=document.createElement("option");t.value=String(this.currentLayerSetId||0),t.textContent=mw.message?mw.message("layers-revision-latest").text():"Latest",e.appendChild(t);var a=this;if(this.allLayerSets.slice().sort(function(e,t){var a=parseInt(e.ls_revision,10)||0,r=parseInt(t.ls_revision,10)||0;if(r!==a)return r-a;var s=e.ls_timestamp||"";return(t.ls_timestamp||"").localeCompare(s)}).forEach(function(t){var r=parseInt(t.ls_id,10),s=parseInt(t.ls_revision,10),n=t.ls_timestamp||"",i=a.formatTimestamp(n),o=t.ls_name||"",l=t.ls_user_name||(t.ls_user_id?"User "+t.ls_user_id:""),d=mw.message?mw.message("layers-revision-by",l).text():l?"by "+l:"",c="#"+s+(o?" â€” "+o:"")+(i?" â€” "+i:"")+(d?" â€” "+d:"")+(a.currentLayerSetId&&r===a.currentLayerSetId?mw.message?mw.message("layers-revision-current-suffix").text():" (current)":""),y=document.createElement("option");y.value=String(r),y.textContent=c,e.appendChild(y)}),this.revLoadBtnEl){var r=this.currentLayerSetId&&String(this.currentLayerSetId)===t.value;this.revLoadBtnEl.disabled=!!r}}},t.prototype.formatTimestamp=function(e){if(!e||"string"!=typeof e)return"";var t;if(/^\d{14}$/.test(e)){var a=parseInt(e.slice(0,4),10),r=parseInt(e.slice(4,6),10)-1,s=parseInt(e.slice(6,8),10),n=parseInt(e.slice(8,10),10),i=parseInt(e.slice(10,12),10),o=parseInt(e.slice(12,14),10);t=new Date(Date.UTC(a,r,s,n,i,o))}else t=new Date(e);if(isNaN(t.getTime()))return e;try{return t.toLocaleString()}catch(t){return e}},t.prototype.loadRevisionById=function(e){if(this.currentLayerSetId&&e===this.currentLayerSetId)mw.notify(mw.message?mw.message("layers-revision-already-current").text():"That revision is already loaded",{type:"info"});else{if(this.isDirty){var t=mw.message?mw.message("layers-load-revision-unsaved-confirm").text():"You have unsaved changes. Load revision anyway?";if(!window.confirm(t))return}for(var a=null,r=0;r<this.allLayerSets.length;r++)if(parseInt(this.allLayerSets[r].ls_id,10)===e){a=this.allLayerSets[r];break}if(a)try{var s="string"==typeof a.ls_json_blob?JSON.parse(a.ls_json_blob):a.ls_json_blob||{},n=Array.isArray(s.layers)?s.layers:[];this.saveState("load-revision"),this.layers=n.map(function(e){return e.id||(e.id="layer_"+Date.now()+"_"+Math.random().toString(36).slice(2,9)),e}),this.currentLayerSetId=e,this.renderLayers(),this.markDirty(),mw.notify(mw.message?mw.message("layers-revision-loaded").text():"Revision loaded",{type:"info"})}catch(e){mw.notify(mw.message?mw.message("layers-revision-load-error").text():"Failed to load revision",{type:"error"})}else mw.notify(mw.message?mw.message("layers-revision-not-found").text():"Revision not found",{type:"warn"})}},t.prototype.reloadRevisions=function(){var e=this;(new mw.Api).get({action:"layersinfo",filename:this.filename,format:"json"}).done(function(t){t.layersinfo&&(Array.isArray(t.layersinfo.all_layersets)&&(e.allLayerSets=t.layersinfo.all_layersets.slice()),t.layersinfo.layerset&&t.layersinfo.layerset.id&&(e.currentLayerSetId=t.layersinfo.layerset.id),e.buildRevisionSelector(),e.revNameInputEl&&(e.revNameInputEl.value=""))})},t.prototype.renderLayers=function(){if(this.canvasManager&&this.canvasManager.renderLayers(this.layers),this.layerPanel&&(this.layerPanel.updateLayers(this.layers),"function"==typeof this.layerPanel.renderCodeSnippet&&this.statusBar)){var e=this.layerPanel.renderCodeSnippet(this.layers),t=e.match(/<code[^>]*>([\s\S]*?)<\/code>/i),a=e.match(/data-code="([^"]+)"/i),r=t?t[1]:"",s=a?a[1]:"",n=this.statusBar.querySelector(".status-code-text"),i=this.statusBar.querySelector(".status-copy-btn");if(n&&(n.textContent=r),i){var o=this.layerPanel.msg?this.layerPanel.msg.bind(this.layerPanel):function(e,t){return t};i.onclick=function(){var e=s||r,t=function(){i.textContent=o("layers-code-copied","Copied!"),setTimeout(function(){i.textContent=o("layers-code-copy","Copy")},1500)},a=function(){i.textContent=o("layers-code-copy-failed","Copy failed"),setTimeout(function(){i.textContent=o("layers-code-copy","Copy")},1500)};if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(e).then(t).catch(function(){var r=document.createElement("textarea");r.value=e,document.body.appendChild(r),r.select();try{document.execCommand("copy")?t():a()}catch(e){a()}document.body.removeChild(r)});else{var n=document.createElement("textarea");n.value=e,document.body.appendChild(n),n.select();try{document.execCommand("copy")?t():a()}catch(e){a()}document.body.removeChild(n)}}}}this.updateUIState()},t.prototype.addLayer=function(e){this.saveState(),e.id=this.generateLayerId(),e.visible=!1!==e.visible,this.layers.unshift(e),this.renderLayers(),this.markDirty(),this.selectLayer(e.id)},t.prototype.updateLayer=function(e,t){this.saveState();var a=this.getLayerById(e);a&&($.extend(a,t),this.renderLayers(),this.markDirty())},t.prototype.removeLayer=function(e){this.saveState(),this.layers=this.layers.filter(function(t){return t.id!==e}),this.renderLayers(),this.markDirty(),this.updateUIState()},t.prototype.getLayerById=function(e){return this.layers.find(function(t){return t.id===e})},t.prototype.generateLayerId=function(){return"layer_"+Date.now()+"_"+Math.random().toString(36).slice(2,11)},t.prototype.setCurrentTool=function(e){this.currentTool=e,this.canvasManager&&this.canvasManager.setTool(e)},t.prototype.saveState=function(e){this.canvasManager&&this.canvasManager.saveState(e)},t.prototype.undo=function(){return!!this.canvasManager&&this.canvasManager.undo()},t.prototype.redo=function(){return!!this.canvasManager&&this.canvasManager.redo()},t.prototype.selectLayer=function(e){this.selectedLayerId=e,this.canvasManager&&this.canvasManager.selectLayer(e),this.layerPanel&&this.layerPanel.selectLayer(e),this.updateUIState()},t.prototype.deleteSelected=function(){this.selectedLayerId&&(this.removeLayer(this.selectedLayerId),this.selectedLayerId=null)},t.prototype.duplicateSelected=function(){if(this.selectedLayerId){var e=this.getLayerById(this.selectedLayerId);if(e){var t=JSON.parse(JSON.stringify(e));t.x=(t.x||0)+10,t.y=(t.y||0)+10,delete t.id,this.addLayer(t)}}},t.prototype.updateUIState=function(){if(this.toolbar){var e=!!this.canvasManager&&this.canvasManager.historyIndex>0,t=!!this.canvasManager&&this.canvasManager.historyIndex<this.canvasManager.history.length-1;this.toolbar.updateUndoRedoState(e,t),this.toolbar.updateDeleteState(!!this.selectedLayerId)}},t.prototype.applyToSelection=function(e){if("function"==typeof e){var t=this.getSelectedLayerIds();if(t.length){this.saveState();for(var a=0;a<t.length;a++){var r=this.getLayerById(t[a]);r&&e(r)}this.renderLayers(),this.markDirty()}}},t.prototype.getSelectedLayerIds=function(){return this.canvasManager&&Array.isArray(this.canvasManager.selectedLayerIds)?this.canvasManager.selectedLayerIds.slice():this.selectedLayerId?[this.selectedLayerId]:[]},t.prototype.cancel=function(e){if(this.isDirty){var t=mw.message?mw.message("layers-unsaved-cancel-confirm").text():"You have unsaved changes. Are you sure you want to cancel?";window.OO&&window.OO.ui&&window.OO.ui.confirm?window.OO.ui.confirm(t).done(function(e){e&&(this.destroy(),this.navigateBackToFile())}.bind(this)):window.confirm(t)&&(this.destroy(),this.navigateBackToFile())}else this.destroy(),e&&this.navigateBackToFile()},t.prototype.navigateBackToFile=function(){try{if(this.filename&&mw&&mw.util&&"function"==typeof mw.util.getUrl){var e=mw.util.getUrl("File:"+this.filename);return void(window.location.href=e)}window.history&&window.history.length>1?window.history.back():window.location.reload()}catch(e){window.location.reload()}},t.prototype.save=function(){var e=this;if(window.LayersValidator){var t=new window.LayersValidator,a=t.validateLayers(this.layers,100);if(!a.isValid)return void t.showValidationErrors(a.errors,"save");if(a.warnings&&a.warnings.length>0&&window.mw&&window.mw.notify){var r="Warnings: "+a.warnings.join("; ");mw.notify(r,{type:"warn"})}}e.showSpinner(mw.message?mw.message("layers-saving").text():"Saving..."),this.toolbar&&this.toolbar.saveButton&&(this.toolbar.saveButton.disabled=!0,setTimeout(function(){e.toolbar.saveButton.disabled=!1},2e3));var s=new mw.Api,n=JSON.stringify(this.layers),i=mw.config&&mw.config.get&&mw.config.get("wgLayersMaxBytes")||0;if(i&&n.length>i)return e.hideSpinner(),void mw.notify(mw.message?mw.message("layers-data-too-large").text():"Layer data is too large to save.",{type:"error"});var o={action:"layerssave",filename:this.filename,data:n,format:"json"};if(this.revNameInputEl&&this.revNameInputEl.value){var l=this.revNameInputEl.value.trim();l&&(o.setname=l)}this.debugLog("Layers save payload:",o),this.debugLog("Layer count:",this.layers.length),this.layers.forEach(function(t,a){e.debugLog("Layer "+a+":",t),t.shadow&&e.debugLog("  Shadow properties:",{shadow:t.shadow,shadowColor:t.shadowColor,shadowBlur:t.shadowBlur,shadowOffsetX:t.shadowOffsetX,shadowOffsetY:t.shadowOffsetY,shadowSpread:t.shadowSpread})}),s.postWithToken("csrf",o).done(function(t){if(e.hideSpinner(),e.debugLog("Layers save API response:",t),t.layerssave&&t.layerssave.success)e.markClean(),mw.notify(mw.message?mw.message("layers-save-success").text():mw.msg?mw.msg("layers-save-success"):"Saved",{type:"success"}),e.reloadRevisions();else{var a=t.error&&t.error.info||t.layerssave&&t.layerssave.error||(mw.message?mw.message("layers-save-error").text():"Error saving layers");e.debugLog("Save failed. Expected data.layerssave.success, got:"),e.debugLog("data.layerssave:",t.layerssave),e.debugLog("data.error:",t.error),mw.notify("Save failed: "+a,{type:"error"}),e.showError("Save failed: "+a),e.errorLog("Layers save API error:",t)}}).fail(function(t,a){e.hideSpinner();var r=mw.message?mw.message("layers-save-error").text():"Error saving layers";a&&a.error&&a.error.info&&(r=a.error.info),mw.notify("API Error: "+r,{type:"error"}),e.showError("API Error: "+r),e.errorLog("Layers save API failure:",t,a)})},t.prototype.markDirty=function(){this.isDirty=!0},t.prototype.markClean=function(){this.isDirty=!1},t.prototype.getParentImageUrl=function(){if(this.config.imageUrl)return this.config.imageUrl;if(this.filename)return mw.config.get("wgServer")+mw.config.get("wgScriptPath")+"/index.php?title=Special:Redirect/file/"+encodeURIComponent(this.filename);var e=document.querySelector(".mw-file-element img, .fullImageLink img, .filehistory img");return e?e.getAttribute("src"):null},t.prototype.showError=function(e){var t=document.createElement("div");t.className="layers-error",t.style.cssText="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid #d63638; border-radius: 8px; z-index: 10001; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);";var a=document.createElement("h3");a.textContent="Error",t.appendChild(a);var r=document.createElement("p");r.textContent=String(e||""),t.appendChild(r),this.container.appendChild(t),setTimeout(function(){t.style.opacity="0",setTimeout(function(){t.parentNode&&t.parentNode.removeChild(t)},500)},1e4)},t.prototype.handleResize=function(){if(this.canvasManager&&this.canvasManager.handleCanvasResize(),this.canvasManager&&this.canvasManager.resizeCanvas){var e=this;setTimeout(function(){e.canvasManager.resizeCanvas()},100)}},t.prototype.destroy=function(){this.canvasManager&&"function"==typeof this.canvasManager.destroy&&this.canvasManager.destroy(),this.layerPanel&&"function"==typeof this.layerPanel.destroy&&this.layerPanel.destroy(),this.toolbar&&"function"==typeof this.toolbar.destroy&&this.toolbar.destroy(),this.onResizeHandler&&(window.removeEventListener("resize",this.onResizeHandler),this.onResizeHandler=null),this.onBeforeUnloadHandler&&(window.removeEventListener("beforeunload",this.onBeforeUnloadHandler),this.onBeforeUnloadHandler=null),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.spinnerEl&&this.spinnerEl.parentNode&&(this.spinnerEl.parentNode.removeChild(this.spinnerEl),this.spinnerEl=null),this.canvasManager=null,this.layerPanel=null,this.toolbar=null,this.container=null,this.containerElement=null,this.$canvasContainer=null,this.$layerPanel=null,this.$toolbar=null,this.layers=[],this.allLayerSets=[],this.undoStack=[],this.redoStack=[],document.body.classList.remove("layers-editor-open"),-1!==document.title.indexOf("Layers Editor")&&(document.title=document.title.replace(/ðŸŽ¨ Layers Editor.*/,"").trim())},window.LayersEditor=t,mw.hook("layers.editor.init").add(function(e){document.title="ðŸŽ¨ Layers Editor Initializing...";var a=new t(e);document.title="ðŸŽ¨ Layers Editor - "+(e.filename||"Unknown File"),window.mw&&window.mw.config.get("debug")&&(window.layersEditorInstance=a)}),function(){function e(){try{var t=window.location&&window.location.search&&window.location.search.indexOf("layers_debug=1")>-1||window.mw&&mw.config&&mw.config.get("wgLayersDebug");if(t&&mw.log&&mw.log("Layers: Auto-bootstrap starting..."),!window.mw||!mw.config||!mw.config.get)return t&&mw.log&&mw.log("Layers: MediaWiki not ready, retrying in 100ms..."),void setTimeout(e,100);var a=mw.config.get("wgLayersEditorInit");if(t&&mw.log&&mw.log("Layers: wgLayersEditorInit config:",a),!a)return void(t&&mw.log&&mw.log("Layers: No wgLayersEditorInit config found, not auto-bootstrapping"));var r=document.getElementById("layers-editor-container");t&&mw.log&&mw.log("Layers: Container element:",r),mw.hook("layers.editor.init").fire({filename:a.filename,imageUrl:a.imageUrl,container:r||document.body}),t&&mw.log&&mw.log("Layers: Auto-bootstrap fired layers.editor.init hook")}catch(e){mw.log&&mw.log.error("Layers: Auto-bootstrap error:",e)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}()}(),window["Layersext.layers.editor"]={}})();