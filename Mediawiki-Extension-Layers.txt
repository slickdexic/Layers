{{Extension
|image           = ExtensionLayersEditor.png
|name            = Layers
|status          = stable
|type1           = media
|type2           = interface
|type3           = api
|author          = [[User:Pvodrazka|Paul Vodrazka]]
|version         = 1.5.0-beta.4
|update          = 2026-01-06
|download        = {{GithubDownload|slickdexic|Layers}}
|readme          = [https://github.com/slickdexic/Layers/blob/main/README.md README]
|changelog       = [https://github.com/slickdexic/Layers/blob/main/CHANGELOG.md CHANGELOG]
|license         = GPL-2.0-or-later
|tags            = {{bulleted list|{{tag|annotation|o}}|{{tag|canvas|o}}|{{tag|drawing|o}}|{{tag|image editor|o}}|{{tag|image markup|o}}|{{tag|non-destructive|o}}}}
|mediawiki       = >= 1.44
|php             = >= 8.1
|needs-updatephp = yes
|table1          = layer_assets
|table2          = layer_set_usage
|table3          = layer_sets
|rights          = {{bulleted list|editlayers|managelayerlibrary}}
|parameters      = {{bulleted list|$wgLayersMaxBytes|$wgLayersMaxImageBytes|$wgLayersMaxLayerCount|$wgLayersMaxNamedSets|$wgLayersMaxRevisionsPerSet}}
|hook1           = BeforePageDisplay
|hook2           = BitmapHandlerTransform
|hook3           = FileDeleteComplete
|hook4           = ImageBeforeProduceHTML
|hook5           = LinkerMakeMediaLinkFile
|hook6           = LoadExtensionSchemaUpdates
|hook7           = MakeGlobalVariablesScript
|hook8           = ParserBeforeInternalParse
|hook9           = ParserFirstCallInit
|hook10          = ParserMakeImageParams
|hook11          = SkinTemplateNavigation::Universal
|hook12          = ThumbnailBeforeProduceHTML
|description     = A professional-grade, non-destructive image annotation system with 13 drawing tools, curved arrows, live preview, layer folders, style presets, named layer sets, custom shape library, and full keyboard accessibility.
}}

The '''Layers''' extension is a modern, non-destructive image annotation and editing tool for MediaWiki. It enables users to add captions, callouts, highlights, shapes, and freehand drawings to images '''without altering the original file'''.

All edits are stored as validated JSON and rendered client-side for precise positioning. The system fully integrates into MediaWiki's file pages and parser. Click the {{key press|'''Edit layers'''}} tab on any image's <code>File:</code> page to access the editor.

== Why Layers? ==
* '''Professional Tools:''' 13 drawing tools, style presets, and industry-standard alignment—everything needed to annotate like a pro.
* '''Non-Destructive:''' Original images are never modified. Annotations are stored separately and can be versioned or removed at any time.
* '''Accessible:''' WCAG 2.1 compliant with full keyboard navigation, screen reader support, and high-contrast indicators.

== Installation ==
=== Branch Selection ===
{{Note|text=MediaWiki 1.39 LTS reached end-of-life on December 31, 2025. The REL1_43 branch provides full feature parity with main and is recommended for MediaWiki 1.43 users.}}

{| class="wikitable"
! MediaWiki Version !! Branch !! Current Version
|-
| 1.44+ || <code>main</code> || 1.5.0-beta.4
|-
| 1.43.x (LTS) || <code>[https://github.com/slickdexic/Layers/tree/REL1_43 REL1_43]</code> || 1.5.0-beta.4-REL1_43
|-
| 1.39 - 1.42 || <code>[https://github.com/slickdexic/Layers/tree/REL1_39 REL1_39]</code> || 1.1.14 (community maintained)
|}
{{ExtensionInstall
|registration=required
|db-update=yes
|custom-steps=
*Developers considering running tests, linting, etc. should run <code>composer install</code> and <code>npm install</code> within the newly created <code>Layers</code> directory.
|download-link=Download the suitable binary for your MediaWiki version (either [https://github.com/slickdexic/Layers/archive/refs/heads/main.zip main], [https://github.com/slickdexic/Layers/archive/refs/heads/REL1_43.zip REL1_43] or [https://github.com/slickdexic/Layers/archive/refs/heads/REL1_39.zip REL1_39])
}}

== Configuration ==
=== Parameters ===
{| class="wikitable"
! Variable !! Type !! Default !! Description
|-
| <code>$wgLayersMaxLayerCount</code> || integer || <code>100</code> || Max layers per set.
|-
| <code>$wgLayersMaxNamedSets</code> || integer || <code>15</code> || Max named sets per image.
|-
| <code>$wgLayersMaxRevisionsPerSet</code> || integer || <code>50</code> || Historical revisions to keep.
|-
| <code>$wgLayersMaxImageBytes</code> || integer || <code>1048576</code> || Max size for imported image layers.
|-
| <code>$wgLayersMaxBytes</code> || integer || <code>2097152</code> || Max JSON size for a single layer set.
|}

=== Permissions ===
{| class="wikitable"
! Right !! Description !! Default Groups
|-
| <code>editlayers</code> || Edit existing layer sets || <code>user</code>
|-
| <code>createlayers</code> || Create new layer sets || <code>autoconfirmed</code>
|-
| <code>managelayerlibrary</code> || Manage global layer library || <code>sysop</code>
|}

== Key Features ==

=== Key Object Alignment (v1.1.6+) ===
Industry-standard alignment behavior matching Adobe Illustrator and Photoshop:
* When multiple layers are selected, the '''last selected layer''' becomes the "key object".
* Other layers align '''TO''' the key object, which stays fixed in place.
* Key object is visually distinguished with an '''orange border''' (others have blue).
* Works for all alignment operations: left, center, right, top, middle, bottom.

=== Core Features ===
* '''Curved Arrows (v1.4.0+)''': Arrows support curved paths via a draggable control point for professional diagrams.
* '''Live Color Preview (v1.4.0+)''': Canvas updates in real-time as colors are selected in the color picker.
* '''Live Article Preview (v1.4.0+)''': Layer changes are visible immediately after saving, without needing to reload the page.
* '''Layer Grouping (v1.2.13+)''': Group layers into folders for bulk operations ({{key press|Ctrl}}+{{key press|G}} to group, {{key press|Ctrl}}+{{key press|Shift}}+{{key press|G}} to ungroup).
* '''Named Layer Sets''': Multiple annotation sets per image (e.g., "default", "anatomy-labels").
* '''Style Presets''': Save and reuse style configurations per tool type.
* '''Revision History''': Automatically tracks up to 50 revisions per layer set.
* '''Import/Export''': Add external images as layers or export the final result as a PNG.
* '''TypeScript Support''': Full type definitions for extension developers.

=== Deep Linking (v1.2.0+) ===
Control how users interact with layered images using the <code>layerslink</code> parameter:

{| class="wikitable"
! Parameter !! Behavior !! Use Case
|-
| <code>layerslink=viewer</code> || Opens fullscreen lightbox viewer || Enlarged view for detailed inspection
|-
| <code>layerslink=editor</code> || Opens layer editor directly || Quick access from article to editing
|-
| <code>layerslink=editor-newtab</code> || Opens editor in new browser tab || Edit without losing article context
|-
| <code>layerslink=editor-modal</code> || Opens editor in iframe overlay || Perfect for Page Forms integration
|}

{{note|text=Please note that {{para|layerslink|editor-modal}} requires <code>{{ll|1=Manual:$wgEditPageFrameOptions|2=$wgEditPageFrameOptions}} {{=}} 'SAMEORIGIN';</code> in {{ll|1=LocalSettings.php}}.}}

'''Example usage:'''
<syntaxhighlight lang="wikitext">
[[File:Anatomy.png|thumb|layerset=anatomy|layerslink=viewer]]
[[File:Diagram.png|thumb|layerset=labels|layerslink=editor]]
'layers=' was changed to 'layerset=' to be more consistent with the terminology used in the editor.
'layers=' is still supported for backwards compatibility.
</syntaxhighlight>

== Drawing Tools ==
{| class="wikitable"
! Tool !! Shortcut !! Purpose !! Key Features
|-
| Pointer || {{key press|V}} || Select/manipulate || Multi-select, resize, rotate, Key Object alignment
|-
| Text || {{key press|T}} || Simple Text || Click to place, inline editing
|-
| Text Box || {{key press|X}} || Advanced Text || Word wrap, alignment, padding, corner radius
|-
| Callout || {{key press|B}} || Speech Bubbles || Draggable tail, 3 tail styles, rounded corners
|-
| Pen || {{key press|P}} || Freehand || Smooth paths, adjustable stroke
|-
| Rectangle || {{key press|R}} || Basic Shape || Adjustable stroke, fill, corner radius
|-
| Circle || {{key press|C}} || Basic Shape || Perfect circles with stroke and fill
|-
| Ellipse || {{key press|E}} || Basic Shape || Oval shapes with independent radii
|-
| Polygon || {{key press|Y}} || Complex Shape || Configurable sides, rounded corners
|-
| Star || {{key press|S}} || Complex Shape || Configurable points and radii
|-
| Arrow || {{key press|A}} || Annotations || Configurable head types, curved paths, line styles
|-
| Line || {{key press|L}} || Annotations || Simple lines with adjustable stroke
|-
| Custom Shape || — || Shape Library || Arrows, symbols, flowchart shapes, and more
|}

== Technical Details ==
* '''Performance:''' Architecture splits the lightweight Viewer (~2,800 lines) from the Editor (~61k lines).
* '''Stability:''' 8,522 Jest tests across 145 test suites achieving 94.6% statement coverage.
* '''Security:''' Property whitelisting (50+ fields), CSRF protection, and strict text sanitization.
* '''Accessibility:''' WCAG 2.1 compliant with <code>prefers-reduced-motion</code> support, ARIA live regions, and skip links.

== See also ==
* [https://github.com/slickdexic/Layers/blob/main/CHANGELOG.md Full Changelog]
* [https://github.com/slickdexic/Layers/wiki Project Wiki]