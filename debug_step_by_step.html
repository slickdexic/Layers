<!DOCTYPE html>
<html>
<head>
    <title>Canvas Debug - Step by Step</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .step h3 { margin: 0 0 10px 0; color: #333; }
        .canvas-test { border: 2px solid #007bff; margin: 10px 0; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Canvas Debug - Step by Step</h1>
    
    <div class="step">
        <h3>Step 1: Basic Canvas Test</h3>
        <canvas id="test1" class="canvas-test" width="300" height="200"></canvas>
        <div id="log1" class="log"></div>
    </div>
    
    <div class="step">
        <h3>Step 2: Canvas with Background</h3>
        <canvas id="test2" class="canvas-test" width="300" height="200"></canvas>
        <div id="log2" class="log"></div>
    </div>
    
    <div class="step">
        <h3>Step 3: Container Test</h3>
        <div id="container3" style="border: 2px solid #007bff; width: 300px; height: 200px; position: relative;">
            <!-- Canvas will be added here -->
        </div>
        <div id="log3" class="log"></div>
    </div>
    
    <div class="step">
        <h3>Step 4: CanvasManager Test</h3>
        <div id="container4" style="border: 2px solid #007bff; width: 400px; height: 300px; position: relative;">
            <canvas width="400" height="300"></canvas>
        </div>
        <div id="log4" class="log"></div>
    </div>

    <script>
        function log(stepId, message, type = 'info') {
            const logEl = document.getElementById('log' + stepId);
            const span = document.createElement('div');
            span.className = type;
            span.textContent = new Date().toLocaleTimeString() + ': ' + message;
            logEl.appendChild(span);
            console.log(`[Step ${stepId}] ${message}`);
        }

        // Step 1: Basic Canvas
        function testStep1() {
            log(1, 'Starting basic canvas test');
            const canvas = document.getElementById('test1');
            const ctx = canvas.getContext('2d');
            
            log(1, `Canvas: ${canvas ? 'Found' : 'Not found'}`, canvas ? 'success' : 'error');
            log(1, `Context: ${ctx ? 'OK' : 'Failed'}`, ctx ? 'success' : 'error');
            log(1, `Canvas size: ${canvas.width}x${canvas.height}`, 'info');
            
            if (ctx) {
                ctx.fillStyle = '#e3f2fd';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#1976d2';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Basic Canvas OK', canvas.width/2, canvas.height/2);
                log(1, 'Basic drawing complete', 'success');
            }
        }

        // Step 2: Canvas with SVG Background
        function testStep2() {
            log(2, 'Starting SVG background test');
            const canvas = document.getElementById('test2');
            const ctx = canvas.getContext('2d');
            
            const svgData = `<svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2"/>
                <text x="50%" y="50%" text-anchor="middle" font-size="14" fill="#666">SVG Background</text>
            </svg>`;
            
            const img = new Image();
            img.onload = function() {
                log(2, 'SVG image loaded successfully', 'success');
                ctx.drawImage(img, 0, 0);
                
                // Add overlay
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.fillRect(50, 50, 100, 50);
                ctx.fillStyle = '#ff0000';
                ctx.font = '12px Arial';
                ctx.fillText('Overlay', 100, 80);
                
                log(2, 'SVG background with overlay complete', 'success');
            };
            
            img.onerror = function() {
                log(2, 'SVG image failed to load', 'error');
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
        }

        // Step 3: Container Canvas Creation
        function testStep3() {
            log(3, 'Testing canvas creation in container');
            const container = document.getElementById('container3');
            
            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.width = 300;
            canvas.height = 200;
            canvas.style.border = '1px solid #ccc';
            container.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            log(3, 'Canvas created and added to container', 'success');
            
            // Draw test pattern
            ctx.fillStyle = '#ffe0e6';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#d32f2f';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Dynamic Canvas', canvas.width/2, canvas.height/2);
            
            log(3, 'Dynamic canvas drawing complete', 'success');
        }

        // Step 4: Load and test CanvasManager
        function testStep4() {
            log(4, 'Loading CanvasManager...');
            
            // Mock MW
            if (!window.mw) {
                window.mw = {
                    config: { get: function() { return ''; } }
                };
            }
            
            const script = document.createElement('script');
            script.src = 'resources/ext.layers.editor/CanvasManager.js';
            
            script.onload = function() {
                log(4, 'CanvasManager script loaded', 'success');
                
                try {
                    const container = document.getElementById('container4');
                    
                    // Mock editor
                    const mockEditor = {
                        filename: 'debug-test.png',
                        layers: []
                    };
                    
                    log(4, 'Creating CanvasManager instance...', 'info');
                    
                    const canvasManager = new window.CanvasManager({
                        container: container,
                        editor: mockEditor
                    });
                    
                    log(4, 'CanvasManager created successfully', 'success');
                    log(4, `Canvas found: ${canvasManager.canvas ? 'YES' : 'NO'}`, canvasManager.canvas ? 'success' : 'error');
                    log(4, `Context found: ${canvasManager.ctx ? 'YES' : 'NO'}`, canvasManager.ctx ? 'success' : 'error');
                    
                    if (canvasManager.canvas) {
                        log(4, `Canvas size: ${canvasManager.canvas.width}x${canvasManager.canvas.height}`, 'info');
                        log(4, `Canvas display: ${canvasManager.canvas.style.width} x ${canvasManager.canvas.style.height}`, 'info');
                    }
                    
                    // Wait and check background
                    setTimeout(() => {
                        if (canvasManager.backgroundImage) {
                            log(4, 'Background image loaded', 'success');
                        } else {
                            log(4, 'Background image not loaded yet', 'info');
                        }
                    }, 2000);
                    
                } catch (error) {
                    log(4, 'Error creating CanvasManager: ' + error.message, 'error');
                    console.error('CanvasManager error:', error);
                }
            };
            
            script.onerror = function() {
                log(4, 'Failed to load CanvasManager script', 'error');
            };
            
            document.head.appendChild(script);
        }

        // Run all tests
        window.addEventListener('load', function() {
            testStep1();
            setTimeout(testStep2, 500);
            setTimeout(testStep3, 1000);
            setTimeout(testStep4, 1500);
        });
    </script>
</body>
</html>
