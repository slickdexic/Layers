<!DOCTYPE html>
<html>
<head>
    <title>Layers Editor - Module Loading Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        .test-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Layers Editor - Module Loading Test</h1>
    <p>This page tests whether the Layers extension modules load correctly and in the right order.</p>

    <div class="test-container">
        <h2>Module Loading Test</h2>
        <div id="status" class="status loading">Initializing test...</div>
        <button id="test-dependencies" onclick="testDependencies()">Test Dependencies</button>
        <button id="test-editor" onclick="testEditor()" disabled>Test Editor Creation</button>
        <button id="clear-log" onclick="clearLog()">Clear Log</button>
        
        <div class="debug-info" id="debug-log">
            <strong>Debug Log:</strong><br>
            <div id="log-content">Starting test...</div>
        </div>
    </div>

    <div class="test-container">
        <h2>Current Module Status</h2>
        <div id="module-status">Checking...</div>
    </div>

    <script>
        // Mock MediaWiki environment for testing
        window.mw = window.mw || {
            config: {
                get: function(key) {
                    return {
                        'wgServer': 'http://localhost',
                        'wgScriptPath': '/mediawiki',
                        'wgTitle': 'Test_Image.jpg'
                    }[key] || '';
                }
            },
            notify: function(msg, opts) {
                log('MW Notify: ' + msg + (opts ? ' (' + opts.type + ')' : ''));
            },
            Api: function() {
                return {
                    get: function() { return { done: function(f) { return this; }, fail: function(f) { return this; } }; },
                    postWithToken: function() { return { done: function(f) { return this; }, fail: function(f) { return this; } }; }
                };
            },
            loader: {
                using: function(module) {
                    log('MW Loader: Request to load ' + module);
                    return Promise.resolve();
                }
            }
        };

        // jQuery mock
        window.$ = window.$ || function(selector) {
            return {
                get: function() { return document.querySelector(selector); },
                find: function() { return this; },
                append: function() { return this; },
                addClass: function() { return this; },
                removeClass: function() { return this; },
                on: function() { return this; }
            };
        };

        function log(message) {
            var logContent = document.getElementById('log-content');
            var timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += '<br>[' + timestamp + '] ' + message;
            logContent.scrollTop = logContent.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-content').innerHTML = 'Log cleared...';
        }

        function updateStatus(message, type) {
            var statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }

        function updateModuleStatus() {
            var status = {
                'CanvasManager': typeof window.CanvasManager !== 'undefined',
                'LayerPanel': typeof window.LayerPanel !== 'undefined', 
                'Toolbar': typeof window.Toolbar !== 'undefined',
                'LayersEditor': typeof window.LayersEditor !== 'undefined'
            };

            var html = '<table border="1" style="width: 100%; border-collapse: collapse;">';
            html += '<tr><th>Module</th><th>Status</th><th>Type</th></tr>';

            for (var module in status) {
                var isLoaded = status[module];
                var type = isLoaded ? typeof window[module] : 'undefined';
                var statusText = isLoaded ? '✅ Loaded' : '❌ Missing';
                var rowColor = isLoaded ? '#d4edda' : '#f8d7da';
                
                html += '<tr style="background: ' + rowColor + '">';
                html += '<td>' + module + '</td>';
                html += '<td>' + statusText + '</td>';
                html += '<td>' + type + '</td>';
                html += '</tr>';
            }
            html += '</table>';

            document.getElementById('module-status').innerHTML = html;
            return status;
        }

        function testDependencies() {
            log('Testing dependencies...');
            updateStatus('Testing dependencies...', 'loading');

            var status = updateModuleStatus();
            var allLoaded = Object.values(status).every(Boolean);

            if (allLoaded) {
                updateStatus('All dependencies loaded successfully!', 'success');
                document.getElementById('test-editor').disabled = false;
                log('✅ All dependencies are available');
            } else {
                var missing = Object.keys(status).filter(key => !status[key]);
                updateStatus('Missing dependencies: ' + missing.join(', '), 'error');
                log('❌ Missing dependencies: ' + missing.join(', '));
            }
        }

        function testEditor() {
            log('Testing editor creation...');
            updateStatus('Testing editor creation...', 'loading');

            try {
                if (typeof window.LayersEditor === 'undefined') {
                    throw new Error('LayersEditor is not available');
                }

                log('Creating LayersEditor instance...');
                
                // Create a container for the editor
                var container = document.createElement('div');
                container.style.cssText = 'width: 600px; height: 400px; border: 1px solid #ccc; margin: 20px 0; background: #f9f9f9;';
                container.innerHTML = '<p style="text-align: center; margin-top: 180px;">Editor would load here...</p>';
                
                // Append to test container
                var testContainer = document.querySelector('.test-container');
                if (document.getElementById('editor-container')) {
                    document.getElementById('editor-container').remove();
                }
                container.id = 'editor-container';
                testContainer.appendChild(container);

                var editor = new window.LayersEditor({
                    filename: 'Test_Image.jpg'
                });

                log('✅ LayersEditor created successfully');
                updateStatus('Editor created successfully!', 'success');

            } catch (error) {
                log('❌ Failed to create editor: ' + error.message);
                updateStatus('Failed to create editor: ' + error.message, 'error');
                console.error('Editor creation error:', error);
            }
        }

        // Initialize
        setTimeout(function() {
            log('Page loaded, checking initial status...');
            testDependencies();
        }, 100);

        // Auto-refresh module status every 2 seconds
        setInterval(updateModuleStatus, 2000);
    </script>

    <!-- Load the actual Layers extension scripts for testing -->
    <script src="resources/ext.layers.editor/CanvasManager.js"></script>
    <script src="resources/ext.layers.editor/LayerPanel.js"></script> 
    <script src="resources/ext.layers.editor/Toolbar.js"></script>
    <script src="resources/ext.layers.editor/LayersEditor.js"></script>

</body>
</html>
